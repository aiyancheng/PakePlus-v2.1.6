<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>视功能检查分析工具</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #1a73e8;
            --primary-light: #4285f4;
            --primary-dark: #0d47a1;
            --secondary-color: #4fc3f7;
            --bg-color: #f8fbff;
            --card-color: #ffffff;
            --text-color: #333333;
            --text-light: #666666;
            --border-color: #dce7ff;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --info-color: #2196f3;
            --shadow: 0 4px 12px rgba(26, 115, 232, 0.1);
            --radius: 10px;
            --training-color: #1a73e8;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* 头部样式 */
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            position: relative;
        }
        
        header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        header p {
            font-size: 1.1rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
        }
        
        /* 免责声明链接 */
        .disclaimer-link {
            position: absolute;
            right: 20px;
            top: 20px;
            background-color: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            text-decoration: none;
            color: white;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .disclaimer-link:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        /* 患者信息区域 */
        .patient-info {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
            padding: 25px;
            background-color: var(--card-color);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }
        
        .patient-info .input-group {
            flex: 1;
            min-width: 200px;
        }
        
        .patient-info label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-dark);
        }
        
        .patient-info input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .patient-info input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
        }
        
        /* 检查部分样式 */
        .section {
            background-color: var(--card-color);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            overflow: hidden;
        }
        
        .section-header {
            background: linear-gradient(to right, var(--primary-color), var(--primary-light));
            color: white;
            padding: 18px 25px;
            font-size: 1.4rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .section-header i {
            font-size: 1.6rem;
        }
        
        .section-content {
            padding: 25px;
        }
        
        /* 输入区域网格 */
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .input-group {
            margin-bottom: 10px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-dark);
            font-size: 1rem;
        }
        
        .input-group label.required::after {
            content: " *";
            color: var(--danger-color);
        }
        
        .input-group input, .input-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .input-group input:focus, .input-group select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
        }
        
        .input-group input.error {
            border-color: var(--danger-color);
        }
        
        .input-group input.required-field {
            border-color: var(--warning-color);
        }
        
        .range-hint {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 5px;
            min-height: 20px;
        }
        
        .range-hint .normal {
            color: var(--success-color);
        }
        
        .range-hint .abnormal {
            color: var(--danger-color);
        }
        
        /* 融像范围特殊样式 */
        .fusion-inputs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .fusion-inputs .input-group {
            margin-bottom: 0;
        }
        
        .fusion-label {
            grid-column: 1 / -1;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-dark);
        }
        
        /* 眼位异常提示 */
        .phoria-alert {
            background-color: #fff8e1;
            border-left: 5px solid var(--warning-color);
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            display: none;
        }
        
        .phoria-alert.show {
            display: block;
        }
        
        .phoria-alert p {
            margin-bottom: 5px;
            font-weight: 600;
            color: #e65100;
        }
        
        .phoria-alert ul {
            padding-left: 20px;
            margin-top: 5px;
        }
        
        /* 分析按钮 */
        .analyze-btn {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 30px auto;
            padding: 16px;
            background: linear-gradient(to right, var(--primary-color), var(--primary-light));
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
        }
        
        .analyze-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(26, 115, 232, 0.4);
        }
        
        .analyze-btn:active {
            transform: translateY(0);
        }
        
        /* 翻转拍行样式 */
        .flipper-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .flipper-row .input-group {
            flex: 1;
        }
        
        /* 结果区域 */
        .results {
            display: none;
            margin-top: 30px;
            padding: 25px;
            background-color: var(--card-color);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }
        
        .results.show {
            display: block;
        }
        
        .results-header {
            font-size: 1.8rem;
            color: var(--primary-dark);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .result-section {
            margin-bottom: 25px;
        }
        
        .result-section h3 {
            font-size: 1.3rem;
            color: var(--primary-color);
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 10px;
            background-color: #f8fbff;
            border-radius: 8px;
            border-left: 4px solid var(--primary-light);
        }
        
        .result-item.abnormal {
            border-left-color: var(--danger-color);
            background-color: #ffebee;
        }
        
        .result-item.normal {
            border-left-color: var(--success-color);
            background-color: #e8f5e9;
        }
        
        .result-label {
            font-weight: 600;
        }
        
        .result-value {
            font-weight: 600;
        }
        
        .result-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .status-normal {
            background-color: var(--success-color);
            color: white;
        }
        
        .status-abnormal {
            background-color: var(--danger-color);
            color: white;
        }
        
        /* 诊断和训练方案容器 */
        .diagnosis-training-container {
            background-color: #f1f8ff;
            border-radius: var(--radius);
            padding: 20px;
            margin-top: 10px;
            border-left: 5px solid #7b1fa2; /* 紫色大括号 */
            position: relative;
        }
        
        .diagnosis-training-container h4 {
            color: var(--primary-dark); /* 蓝色标题 */
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        
        .diagnosis-training-container ul {
            padding-left: 20px;
            margin-bottom: 15px;
        }
        
        .diagnosis-training-container li {
            margin-bottom: 5px;
        }
        
        /* 训练方案样式 */
        .training-plan {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px dashed #ccc;
        }
        
        .training-plan h4 {
            color: var(--training-color); /* 蓝色标题 */
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .training-plan ul {
            padding-left: 20px;
            margin-bottom: 15px;
        }
        
        .training-plan li {
            margin-bottom: 8px;
        }
        
        .training-plan .training-type {
            font-weight: 600;
            color: #5d4037;
        }
        
        .training-plan .training-methods {
            color: #333;
        }
        
        /* 诊断确认度提示 */
        .diagnosis-confidence {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
            padding: 5px 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
            border-left: 3px solid #ff9800;
        }
        
        .diagnosis-confidence.high {
            border-left-color: #4caf50;
        }
        
        .diagnosis-confidence.low {
            border-left-color: #f44336;
        }
        
        /* 诊断计数表 */
        .diagnosis-count-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background-color: white;
            border-radius: 5px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .diagnosis-count-table th {
            background-color: #f5f5f5;
            padding: 10px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #ddd;
        }
        
        .diagnosis-count-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .diagnosis-count-table tr:last-child td {
            border-bottom: none;
        }
        
        .diagnosis-count-table .count-cell {
            text-align: center;
            font-weight: bold;
        }
        
        /* 修改数字颜色：1个绿色，2个黄色，3个及以上红色 */
        .count-1 {
            color: #4caf50; /* 绿色 */
        }
        
        .count-2 {
            color: #ff9800; /* 黄色/橙色 */
        }
        
        .count-3 {
            color: #f44336; /* 红色 */
        }
        
        .count-4 {
            color: #d32f2f; /* 深红色 */
        }
        
        .count-5 {
            color: #b71c1c; /* 更深红色 */
        }
        
        /* 错误提示 */
        .error-message {
            color: var(--danger-color);
            font-size: 0.9rem;
            margin-top: 5px;
            display: none;
        }
        
        .error-message.show {
            display: block;
        }
        
        /* 加载动画 */
        .loader {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loader.show {
            display: block;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ===================== 免责声明模态框样式 ===================== */
        .disclaimer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }
        
        .disclaimer-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .disclaimer-content {
            background-color: var(--card-color);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: slideUp 0.4s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .disclaimer-header {
            background: linear-gradient(to right, var(--primary-color), var(--primary-light));
            color: white;
            padding: 20px 30px;
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: var(--radius) var(--radius) 0 0;
        }
        
        .disclaimer-header i {
            font-size: 1.8rem;
        }
        
        .disclaimer-body {
            padding: 30px;
        }
        
        .disclaimer-section {
            margin-bottom: 25px;
        }
        
        .disclaimer-section:last-child {
            margin-bottom: 0;
        }
        
        .disclaimer-section h3 {
            color: var(--primary-dark);
            margin-bottom: 15px;
            font-size: 1.3rem;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .disclaimer-section h3 i {
            color: var(--primary-color);
        }
        
        .disclaimer-section p {
            margin-bottom: 15px;
            line-height: 1.7;
        }
        
        .disclaimer-section ul {
            margin-left: 25px;
            margin-bottom: 15px;
        }
        
        .disclaimer-section li {
            margin-bottom: 10px;
            line-height: 1.6;
        }
        
        .highlight {
            background-color: #fff8e1;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--warning-color);
            margin: 20px 0;
        }
        
        .highlight p {
            margin-bottom: 5px;
        }
        
        .highlight p:last-child {
            margin-bottom: 0;
        }
        
        .disclaimer-footer {
            padding: 20px 30px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8fbff;
            border-radius: 0 0 var(--radius) var(--radius);
        }
        
        .disclaimer-buttons {
            display: flex;
            gap: 15px;
        }
        
        .disclaimer-btn {
            padding: 12px 25px;
            border: none;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .disclaimer-btn-primary {
            background: linear-gradient(to right, var(--primary-color), var(--primary-light));
            color: white;
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
        }
        
        .disclaimer-btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(26, 115, 232, 0.4);
        }
        
        .disclaimer-btn-secondary {
            background-color: #f1f8ff;
            color: var(--primary-color);
            border: 2px solid var(--border-color);
        }
        
        .disclaimer-btn-secondary:hover {
            background-color: #e3f2fd;
            border-color: var(--primary-light);
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }
        
        .close-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .bottom-disclaimer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            color: var(--text-light);
            font-size: 0.9rem;
        }
        
        .bottom-disclaimer a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s ease;
        }
        
        .bottom-disclaimer a:hover {
            color: var(--primary-dark);
            text-decoration: underline;
        }
        
        /* ===================== 打印和保存按钮样式 ===================== */
        .report-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .report-btn {
            padding: 12px 25px;
            border: none;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-width: 160px;
        }
        
        .print-btn {
            background: linear-gradient(to right, #4caf50, #66bb6a);
            color: white;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }
        
        .print-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(76, 175, 80, 0.4);
        }
        
        .save-btn {
            background: linear-gradient(to right, #2196f3, #42a5f5);
            color: white;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }
        
        .save-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(33, 150, 243, 0.4);
        }
        
        /* ===================== 打印样式 - 已修改为紧凑且居中的格式 ===================== */
        @media print {
            /* 隐藏所有不需要打印的元素 */
            body * {
                visibility: hidden;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            /* 只显示打印报告 */
            #printable-report, #printable-report * {
                visibility: visible;
            }
            
            #printable-report {
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
                background: white !important;
                font-size: 9pt !important;  /* 缩小字体 */
                line-height: 1.2 !important;  /* 减小行高 */
                max-width: 100% !important;
                box-sizing: border-box !important;
            }
            
            /* 隐藏打印时不显示的元素 */
            .no-print, button, .report-actions, .bottom-disclaimer,
            .disclaimer-link, .analyze-btn, .loader, .input-grid,
            .patient-info, .section, #visual-function-form {
                display: none !important;
            }
            
            /* 调整打印边距 - 增加左右边距，解决文字显示不全问题 */
            @page {
                margin: 0.5cm !important;  /* 增加边距确保文字不超出 */
                size: A4 portrait !important; /* 确保A4纸纵向打印 */
            }
            
            /* 打印报告标题样式 */
            .print-report-header {
                text-align: center;
                margin-bottom: 10px !important;
                padding-bottom: 5px !important;
                border-bottom: 2px solid #1a73e8 !important;
                margin-left: 0.5cm !important;
                margin-right: 0.5cm !important;
            }
            
            .print-report-header h1 {
                font-size: 14pt !important;
                margin-bottom: 5px !important;
                color: #1a73e8 !important;
            }
            
            /* 患者信息样式 - 增加边距 */
            .patient-info-print {
                margin-bottom: 15px !important;
                padding: 10px !important;
                background: white !important;
                border: 1px solid #ddd !important;
                border-radius: 3px !important;
                margin-left: 0.5cm !important;
                margin-right: 0.5cm !important;
            }
            
            .patient-info-print table {
                width: 100% !important;
                font-size: 8pt !important;
                border-collapse: collapse !important;
            }
            
            .patient-info-print td {
                padding: 4px 6px !important;
                border: 1px solid #ddd !important;
            }
            
            /* 诊断结果样式 - 增加左右边距 */
            .print-section {
                margin-bottom: 12px !important;
                page-break-inside: avoid !important;
                margin-left: 0.5cm !important;
                margin-right: 0.5cm !important;
            }
            
            .print-section h3 {
                font-size: 10pt !important;
                margin-bottom: 8px !important;
                padding-bottom: 3px !important;
                border-bottom: 1px solid #ddd !important;
                color: #1a73e8 !important;
                background-color: #f8fbff !important;
                padding: 5px 8px !important;
            }
            
            /* 结果项目样式 */
            .print-result-item {
                display: flex !important;
                justify-content: space-between !important;
                padding: 4px 6px !important;
                margin-bottom: 3px !important;
                font-size: 8pt !important;
                border-left: 3px solid #4285f4 !important;
                background-color: #f8fbff !important;
            }
            
            .print-result-item.abnormal {
                border-left-color: #f44336 !important;
                background-color: #ffebee !important;
            }
            
            .print-result-item.normal {
                border-left-color: #4caf50 !important;
                background-color: #e8f5e9 !important;
            }
            
            /* 诊断计数表格样式 - 增加边距 */
            .print-diagnosis-table {
                width: 100% !important;
                font-size: 7pt !important;
                border-collapse: collapse !important;
                margin: 8px 0 !important;
                margin-left: 0 !important;
                margin-right: 0 !important;
            }
            
            .print-diagnosis-table th {
                background-color: #f5f5f5 !important;
                padding: 4px 6px !important;
                text-align: left !important;
                border: 1px solid #ddd !important;
                font-weight: bold !important;
            }
            
            .print-diagnosis-table td {
                padding: 4px 6px !important;
                border: 1px solid #ddd !important;
            }
            
            /* 最终诊断样式 - 增加边距 */
            .print-final-diagnosis {
                background-color: #f1f8ff !important;
                padding: 8px !important;
                margin: 10px 0 !important;
                border-left: 4px solid #7b1fa2 !important;
                border-radius: 3px !important;
                margin-left: 0.5cm !important;
                margin-right: 0.5cm !important;
            }
            
            .print-final-diagnosis h4 {
                font-size: 9pt !important;
                margin-bottom: 5px !important;
                color: #1a73e8 !important;
            }
            
            .print-final-diagnosis p {
                font-size: 9pt !important;
                line-height: 1.3 !important;
            }
            
            /* 训练方案样式 - 增加边距 */
            .print-training-plan {
                background-color: #f8fbff !important;
                padding: 8px !important;
                margin: 10px 0 !important;
                border: 1px solid #dce7ff !important;
                border-radius: 3px !important;
                margin-left: 0.5cm !important;
                margin-right: 0.5cm !important;
            }
            
            .print-training-plan h4 {
                font-size: 9pt !important;
                margin-bottom: 5px !important;
                color: #1a73e8 !important;
            }
            
            .print-training-plan ul {
                margin-left: 15px !important;
                margin-bottom: 5px !important;
            }
            
            .print-training-plan li {
                margin-bottom: 2px !important;
                font-size: 8pt !important;
            }
            
            /* 页脚样式 - 增加边距 */
            .print-footer {
                margin-top: 15px !important;
                padding-top: 8px !important;
                border-top: 1px solid #ddd !important;
                text-align: center !important;
                font-size: 7pt !important;
                color: #666 !important;
                margin-left: 0.5cm !important;
                margin-right: 0.5cm !important;
            }
            
            /* 避免分页 */
            .no-page-break {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
            }
            
            /* 确保表格不被分页 */
            table {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
            }
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .input-grid {
                grid-template-columns: 1fr;
            }
            
            .fusion-inputs {
                grid-template-columns: 1fr;
            }
            
            .flipper-row {
                flex-direction: column;
                gap: 10px;
            }
            
            header h1 {
                font-size: 1.8rem;
            }
            
            .section-header {
                font-size: 1.2rem;
                padding: 15px;
            }
            
            .patient-info, .section-content {
                padding: 20px;
            }
            
            .analyze-btn {
                max-width: 100%;
            }
            
            .diagnosis-count-table {
                font-size: 0.9rem;
            }
            
            .report-actions {
                flex-direction: column;
                align-items: center;
            }
            
            .report-btn {
                width: 100%;
                max-width: 300px;
            }
            
            /* 免责声明响应式 */
            .disclaimer-link {
                position: static;
                margin-top: 10px;
                display: inline-flex;
                justify-content: center;
                width: auto;
            }
            
            .disclaimer-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .disclaimer-buttons {
                flex-direction: column;
                width: 100%;
            }
            
            .disclaimer-btn {
                width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            header h1 {
                font-size: 1.5rem;
            }
            
            .result-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .result-status {
                align-self: flex-start;
            }
            
            .diagnosis-count-table {
                font-size: 0.8rem;
            }
            
            .diagnosis-count-table th,
            .diagnosis-count-table td {
                padding: 8px 5px;
            }
            
            .disclaimer-header {
                font-size: 1.3rem;
                padding: 15px 20px;
            }
            
            .disclaimer-body {
                padding: 20px;
            }
            
            .disclaimer-footer {
                flex-direction: column;
                gap: 15px;
                padding: 15px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-eye"></i> 永州爱眼城眼镜视功能检查分析工具</h1>
            <p>根据视功能检查数据自动分析调节、集合功能及诊断建议</p>
            <a href="#" class="disclaimer-link" id="disclaimer-link">
                <i class="fas fa-exclamation-triangle"></i> 免责和版权声明
            </a>
        </header>
        
        <form id="visual-function-form">
            <div class="patient-info">
                <div class="input-group">
                    <label for="patient-name"><i class="fas fa-user"></i> 患者姓名</label>
                    <input type="text" id="patient-name" placeholder="请输入患者姓名">
                </div>
                <div class="input-group">
                    <label for="patient-age" class="required"><i class="fas fa-birthday-cake"></i> 年龄</label>
                    <input type="number" id="patient-age" placeholder="请输入年龄" min="0" max="120" required>
                    <div class="error-message" id="age-error">年龄为必填项</div>
                </div>
            </div>
            
            <!-- 第一部分：调节功能检查 -->
            <section class="section" id="section-1">
                <div class="section-header">
                    <span><i class="fas fa-search"></i> 第一部分：调节功能检查</span>
                </div>
                <div class="section-content">
                    <div class="input-grid">
                        <div class="input-group">
                            <label for="nra" class="required">负相对调节 (NRA)</label>
                            <input type="text" id="nra" placeholder="+2.00" required>
                            <div class="range-hint">正常范围: +1.50 ~ +2.50</div>
                            <div class="error-message" id="nra-error">NRA为必填项</div>
                        </div>
                        <div class="input-group">
                            <label for="pra" class="required">正相对调节 (PRA)</label>
                            <input type="text" id="pra" placeholder="-3.00" required>
                            <div class="range-hint">正常范围: ≥ -2.50</div>
                            <div class="error-message" id="pra-error">PRA为必填项</div>
                        </div>
                        <div class="input-group">
                            <label for="bcc" class="required">调节反应 (BCC)</label>
                            <input type="text" id="bcc" placeholder="+0.50" required>
                            <div class="range-hint">正常范围: +0.25 ~ +0.75</div>
                            <div class="error-message" id="bcc-error">BCC为必填项</div>
                        </div>
                        <div class="input-group">
                            <label for="amp-od" class="required">右眼调节幅度 (AMP OD)</label>
                            <input type="text" id="amp-od" placeholder="+12.00" required>
                            <div class="range-hint">正常值: 不得小于最小调节幅度2D以上</div>
                            <div class="error-message" id="amp-od-error">右眼调节幅度为必填项</div>
                        </div>
                        <div class="input-group">
                            <label for="amp-os" class="required">左眼调节幅度 (AMP OS)</label>
                            <input type="text" id="amp-os" placeholder="+12.00" required>
                            <div class="range-hint">正常值: 不得小于最小调节幅度2D以上</div>
                            <div class="error-message" id="amp-os-error">左眼调节幅度为必填项</div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- 第二部分：集合功能检查 -->
            <section class="section" id="section-2">
                <div class="section-header">
                    <span><i class="fas fa-crosshairs"></i> 第二部分：集合功能检查</span>
                </div>
                <div class="section-content">
                    <div class="input-grid">
                        <div class="input-group">
                            <label for="pd" class="required">远距离眼位 (PD)</label>
                            <input type="number" id="pd" placeholder="如：-2 (外隐斜)" required>
                            <div class="range-hint">正常范围: +1 ~ -3 (负为外隐斜，正为内隐斜)</div>
                            <div class="error-message" id="pd-error">远距离眼位为必填项</div>
                        </div>
                        <div class="input-group">
                            <label for="pn" class="required">近距离眼位 (PN)</label>
                            <input type="number" id="pn" placeholder="如：-4 (外隐斜)" required>
                            <div class="range-hint">正常范围: 0 ~ -6 (负为外隐斜，正为内隐斜)</div>
                            <div class="error-message" id="pn-error">近距离眼位为必填项</div>
                        </div>
                        <div class="input-group">
                            <label for="aca-type" class="required">AC/A 类型</label>
                            <select id="aca-type" required>
                                <option value="">请选择AC/A类型</option>
                                <option value="calculated">计算性AC/A</option>
                                <option value="gradient">梯度性AC/A</option>
                            </select>
                            <div class="error-message" id="aca-type-error">AC/A类型为必填项</div>
                        </div>
                        <div class="input-group">
                            <label for="aca-value" class="required">AC/A 比值</label>
                            <input type="number" id="aca-value" step="0.1" placeholder="5.0" required>
                            <div class="range-hint" id="aca-range">正常范围: 选择类型后显示</div>
                            <div class="error-message" id="aca-value-error">AC/A比值为必填项</div>
                        </div>
                        <div class="input-group">
                            <label for="npc" class="required">集合近点 (NPC) - 破裂点 (cm)</label>
                            <input type="number" id="npc" step="0.1" placeholder="6.5" required>
                            <div class="range-hint">正常范围: 3~ 7 cm</div>
                            <div class="error-message" id="npc-error">集合近点为必填项</div>
                        </div>
                    </div>
                    
                    <!-- 眼位异常提示 -->
                    <div class="phoria-alert" id="phoria-alert">
                        <p><i class="fas fa-exclamation-triangle"></i> 检测到眼位异常</p>
                        <div id="phoria-details"></div>
                        <p style="margin-top: 10px;">根据眼位异常类型，以下融像范围必须填写：</p>
                        <ul id="required-fusion-list"></ul>
                    </div>
                    
                    <!-- 融像范围输入 -->
                    <h3 style="margin-top: 25px; margin-bottom: 15px; color: var(--primary-dark);">远距离融像范围 (5m)</h3>
                    <div class="input-grid">
                        <div class="input-group">
                            <div class="fusion-label">BI (负融像性聚散)</div>
                            <div class="fusion-inputs">
                                <div class="input-group">
                                    <label for="far-bi-blur">模糊点</label>
                                    <input type="number" id="far-bi-blur" step="1" placeholder="X">
                                </div>
                                <div class="input-group">
                                    <label for="far-bi-break">破裂点</label>
                                    <input type="number" id="far-bi-break" step="1" placeholder="4-10">
                                </div>
                                <div class="input-group">
                                    <label for="far-bi-recovery">恢复点</label>
                                    <input type="number" id="far-bi-recovery" step="1" placeholder="2-6">
                                </div>
                            </div>
                            <div class="range-hint">BI正常值: X/4-10/2-6</div>
                        </div>
                        
                        <div class="input-group">
                            <div class="fusion-label">BO (正融像性聚散)</div>
                            <div class="fusion-inputs">
                                <div class="input-group">
                                    <label for="far-bo-blur">模糊点</label>
                                    <input type="number" id="far-bo-blur" step="1" placeholder="5-13">
                                </div>
                                <div class="input-group">
                                    <label for="far-bo-break">破裂点</label>
                                    <input type="number" id="far-bo-break" step="1" placeholder="11-27">
                                </div>
                                <div class="input-group">
                                    <label for="far-bo-recovery">恢复点</label>
                                    <input type="number" id="far-bo-recovery" step="1" placeholder="6-14">
                                </div>
                            </div>
                            <div class="range-hint">BO正常值: 5-13/11-27/6-14</div>
                        </div>
                    </div>
                    
                    <h3 style="margin-top: 25px; margin-bottom: 15px; color: var(--primary-dark);">近距离融像范围 (0.4m)</h3>
                    <div class="input-grid">
                        <div class="input-group">
                            <div class="fusion-label">BI (负融像性聚散)</div>
                            <div class="fusion-inputs">
                                <div class="input-group">
                                    <label for="near-bi-blur">模糊点</label>
                                    <input type="number" id="near-bi-blur" step="1" placeholder="9-17">
                                </div>
                                <div class="input-group">
                                    <label for="near-bi-break">破裂点</label>
                                    <input type="number" id="near-bi-break" step="1" placeholder="17-25">
                                </div>
                                <div class="input-group">
                                    <label for="near-bi-recovery">恢复点</label>
                                    <input type="number" id="near-bi-recovery" step="1" placeholder="8-18">
                                </div>
                            </div>
                            <div class="range-hint">BI正常值: 9-17/17-25/8-18</div>
                        </div>
                        
                        <div class="input-group">
                            <div class="fusion-label">BO (正融像性聚散)</div>
                            <div class="fusion-inputs">
                                <div class="input-group">
                                    <label for="near-bo-blur">模糊点</label>
                                    <input type="number" id="near-bo-blur" step="1" placeholder="12-22">
                                </div>
                                <div class="input-group">
                                    <label for="near-bo-break">破裂点</label>
                                    <input type="number" id="near-bo-break" step="1" placeholder="15-27">
                                </div>
                                <div class="input-group">
                                    <label for="near-bo-recovery">恢复点</label>
                                    <input type="number" id="near-bo-recovery" step="1" placeholder="4-18">
                                </div>
                            </div>
                            <div class="range-hint">BO正常值: 12-22/15-27/4-18</div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- 第三部分：翻转拍检查 -->
            <section class="section" id="section-3">
                <div class="section-header">
                    <span><i class="fas fa-sync-alt"></i> 第三部分：翻转拍检查</span>
                </div>
                <div class="section-content">
                    <div class="flipper-row">
                        <div class="input-group">
                            <label for="monocular-cpm-od" class="required">右眼调节灵敏度 (cpm)</label>
                            <input type="number" id="monocular-cpm-od" step="1" placeholder="15" required>
                            <div class="range-hint">正常值: ≥12 cpm</div>
                            <div class="error-message" id="monocular-cpm-od-error">右眼调节灵敏度为必填项</div>
                        </div>
                        <div class="input-group">
                            <label for="monocular-flipper-od" class="required">右眼翻转拍通过情况</label>
                            <select id="monocular-flipper-od" required>
                                <option value="">请选择通过情况</option>
                                <option value="normal">正常通过</option>
                                <option value="plus-difficulty">正镜片(+2.00)通过困难</option>
                                <option value="minus-difficulty">负镜片(-2.00)通过困难</option>
                                <option value="both-difficulty">正负镜片均困难</option>
                            </select>
                            <div class="error-message" id="monocular-flipper-od-error">右眼翻转拍通过情况为必填项</div>
                        </div>
                    </div>
                    
                    <div class="flipper-row">
                        <div class="input-group">
                            <label for="monocular-cpm-os" class="required">左眼调节灵敏度 (cpm)</label>
                            <input type="number" id="monocular-cpm-os" step="1" placeholder="15" required>
                            <div class="range-hint">正常值: ≥12 cpm</div>
                            <div class="error-message" id="monocular-cpm-os-error">左眼调节灵敏度为必填项</div>
                        </div>
                        <div class="input-group">
                            <label for="monocular-flipper-os" class="required">左眼翻转拍通过情况</label>
                            <select id="monocular-flipper-os" required>
                                <option value="">请选择通过情况</option>
                                <option value="normal">正常通过</option>
                                <option value="plus-difficulty">正镜片(+2.00)通过困难</option>
                                <option value="minus-difficulty">负镜片(-2.00)通过困难</option>
                                <option value="both-difficulty">正负镜片均困难</option>
                            </select>
                            <div class="error-message" id="monocular-flipper-os-error">左眼翻转拍通过情况为必填项</div>
                        </div>
                    </div>
                    
                    <div class="flipper-row">
                        <div class="input-group">
                            <label for="binocular-cpm" class="required">双眼调节灵敏度 (cpm)</label>
                            <input type="number" id="binocular-cpm" step="1" placeholder="10" required>
                            <div class="range-hint">正常值: ≥8 cpm</div>
                            <div class="error-message" id="binocular-cpm-error">双眼调节灵敏度为必填项</div>
                        </div>
                        <div class="input-group">
                            <label for="binocular-flipper" class="required">双眼翻转拍通过情况</label>
                            <select id="binocular-flipper" required>
                                <option value="">请选择通过情况</option>
                                <option value="normal">正常通过</option>
                                <option value="plus-difficulty">正镜片(+2.00)通过困难</option>
                                <option value="minus-difficulty">负镜片(-2.00)通过困难</option>
                                <option value="both-difficulty">正负镜片均困难</option>
                            </select>
                            <div class="error-message" id="binocular-flipper-error">双眼翻转拍通过情况为必填项</div>
                        </div>
                    </div>
                </div>
            </section>
            
            <button type="button" class="analyze-btn" id="analyze-btn">
                <i class="fas fa-stethoscope"></i> 开始分析视功能
            </button>
        </form>
        
        <!-- 加载动画 -->
        <div class="loader" id="loader">
            <div class="spinner"></div>
            <p>正在分析数据，请稍候...</p>
        </div>
        
        <!-- 结果显示区域 -->
        <div class="results" id="results">
            <div class="results-header">
                <i class="fas fa-clipboard-check"></i> 视功能检查分析报告
            </div>
            
            <div class="patient-summary result-section">
                <h3><i class="fas fa-user-md"></i> 患者信息</h3>
                <div class="result-item">
                    <div class="result-label">姓名</div>
                    <div class="result-value" id="result-name">-</div>
                </div>
                <div class="result-item">
                    <div class="result-label">年龄</div>
                    <div class="result-value" id="result-age">-</div>
                </div>
                <div class="result-item">
                    <div class="result-label">检查日期</div>
                    <div class="result-value" id="result-date">-</div>
                </div>
            </div>
            
            <div class="result-section">
                <h3><i class="fas fa-search"></i> 调节功能分析结果</h3>
                <div id="accommodation-results"></div>
            </div>
            
            <div class="result-section">
                <h3><i class="fas fa-crosshairs"></i> 集合功能分析结果</h3>
                <div id="vergence-results"></div>
            </div>
            
            <div class="result-section">
                <h3><i class="fas fa-sync-alt"></i> 翻转拍检查分析结果</h3>
                <div id="flipper-results"></div>
            </div>
            
            <!-- 综合诊断与视觉训练方案合并为一个部分，有紫色大括号 -->
            <div class="result-section">
                <h3><i class="fas fa-diagnoses"></i> 综合诊断与视觉训练方案</h3>
                <div class="diagnosis-training-container" id="diagnosis-training-container">
                    <!-- 诊断结果和训练方案内容将在这里动态生成 -->
                </div>
            </div>
            
            <!-- 打印和保存按钮 -->
            <div class="report-actions" id="report-actions">
                <button type="button" class="report-btn print-btn" id="print-report-btn">
                    <i class="fas fa-print"></i> 打印报告
                </button>
                <button type="button" class="report-btn save-btn" id="save-report-btn">
                    <i class="fas fa-save"></i> 保存为文本
                </button>
            </div>
            
            <!-- 底部免责声明链接 -->
            <div class="bottom-disclaimer">
                <p>© 2026 视功能检查分析工具 | <a href="#" id="bottom-disclaimer-link">免责声明</a></p>
                <p>本工具生成的结果仅供参考，不能替代专业医疗建议</p>
            </div>
        </div>
    </div>

    <!-- 免责声明模态框 -->
    <div class="disclaimer-modal" id="disclaimer-modal">
        <div class="disclaimer-content">
            <div class="disclaimer-header">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>免责声明</span>
                </div>
                <button class="close-btn" id="close-disclaimer">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="disclaimer-body">
                <div class="disclaimer-section">
                    <h3><i class="fas fa-info-circle"></i> 工具性质</h3>
                    <p>本视功能检查分析工具（以下简称"本工具"）是一款基于输入数据进行自动化分析的辅助工具，旨在为视功能检查提供参考性分析结果。本工具不能替代专业眼科医师的诊断和治疗建议。</p>
                </div>
                
                <div class="disclaimer-section">
                    <h3><i class="fas fa-user-md"></i> 非医疗建议</h3>
                    <p>本工具生成的分析结果、诊断建议和训练方案仅为基于算法逻辑的参考信息，不具有医疗诊断效力。所有视觉功能相关问题的最终诊断和治疗方案应由具备相应资质的眼科医师或视光师根据实际检查结果确定。</p>
                    <div class="highlight">
                        <p><strong>重要提醒：</strong>如果您或患者有任何视觉不适、视力下降、眼痛、复视等症状，请立即前往正规医疗机构就诊，切勿仅依赖本工具的分析结果进行自我诊断或治疗。</p>
                    </div>
                </div>
                
                <div class="disclaimer-section">
                    <h3><i class="fas fa-shield-alt"></i> 数据准确性</h3>
                    <p>本工具的分析结果完全依赖于用户输入的数据准确性。任何输入错误或不完整的数据都可能导致分析结果不准确或不适用。用户应确保：</p>
                    <ul>
                        <li>输入数据来自规范的视功能检查流程</li>
                        <li>检查结果由专业人员测量获得</li>
                        <li>数据单位正确无误（如屈光度、棱镜度等）</li>
                        <li>患者的年龄、病史等基本信息准确无误</li>
                    </ul>
                </div>
                
                <div class="disclaimer-section">
                    <h3><i class="fas fa-exclamation-circle"></i> 责任限制</h3>
                    <p>本工具的开发者和提供者对以下情况不承担任何责任：</p>
                    <ul>
                        <li>因使用本工具分析结果而导致的任何直接或间接损失</li>
                        <li>因输入数据错误或不完整导致的分析结果偏差</li>
                        <li>用户根据本工具建议采取行动而产生的任何后果</li>
                        <li>因技术问题导致的服务中断、数据丢失等情况</li>
                        <li>任何第三方基于本工具结果做出的决策或行动</li>
                    </ul>
                </div>
                
                <div class="disclaimer-section">
                    <h3><i class="fas fa-lock"></i> 数据隐私</h3>
                    <p>本工具在浏览器本地运行，所有输入数据仅保存在您的设备中，不会上传到任何服务器。但请注意：</p>
                    <ul>
                        <li>如果您在公共设备上使用本工具，使用后请清除浏览器缓存</li>
                        <li>建议不要在工具中输入患者的完整身份证号等敏感信息</li>
                        <li>对于患者隐私数据的保护，您仍需遵守相关法律法规</li>
                    </ul>
                </div>
                
                <div class="disclaimer-section">
                    <h3><i class="fas fa-gavel"></i> 知识产权</h3>
                    <p>本工具及其相关算法、界面设计、分析逻辑等均受知识产权法保护。未经明确授权，任何个人或组织不得：</p>
                    <ul>
                        <li>对本工具进行反向工程、反编译或分解</li>
                        <li>未经许可复制、修改或分发本工具</li>
                        <li>将本工具用于商业目的而未经授权</li>
                        <li>声称对本工具拥有所有权或开发权</li>
                    </ul>
                </div>
                
                <div class="disclaimer-section">
                    <h3><i class="fas fa-check-circle"></i> 使用同意</h3>
                    <p>使用本工具即表示您已阅读、理解并同意本免责声明的所有条款。如果您不同意任何条款，请立即停止使用本工具。</p>
                    <p>本免责声明可能会不定期更新，建议您定期查看以了解最新条款。</p>
                </div>
            </div>
            
            <div class="disclaimer-footer">
                <div style="color: var(--text-light); font-size: 0.9rem;">
                    <p>© 2026 视功能检查分析工具</p>
                    <p>最后更新日期：2025年12月29日</p>
                </div>
                <div class="disclaimer-buttons">
                    <button class="disclaimer-btn disclaimer-btn-primary" id="agree-disclaimer">
                        <i class="fas fa-check"></i> 同意并继续使用
                    </button>
                    <button class="disclaimer-btn disclaimer-btn-secondary" id="print-disclaimer">
                        <i class="fas fa-print"></i> 打印声明
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 打印报告内容（隐藏，只在打印时显示） -->
    <div id="printable-report" style="display: none;"></div>

    <script>
        // 全局变量
        let phoriaAbnormalities = [];
        let requiredFusionFields = [];
        let problemEyePositions = []; // 存储问题眼位
        let age = 0;
        let currentFinalDiagnosis = "";
        let currentTrainingPlan = "";
        
        // 免责声明相关功能
        const disclaimerModal = document.getElementById('disclaimer-modal');
        const disclaimerLink = document.getElementById('disclaimer-link');
        const bottomDisclaimerLink = document.getElementById('bottom-disclaimer-link');
        const closeDisclaimerBtn = document.getElementById('close-disclaimer');
        const agreeDisclaimerBtn = document.getElementById('agree-disclaimer');
        const printDisclaimerBtn = document.getElementById('print-disclaimer');
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 输入框格式化
            initInputFormatting();
            
            // AC/A类型变化事件
            document.getElementById('aca-type').addEventListener('change', updateACARange);
            
            // 眼位输入变化事件
            document.getElementById('pd').addEventListener('input', checkPhoriaAbnormalities);
            document.getElementById('pn').addEventListener('input', checkPhoriaAbnormalities);
            
            // 年龄输入变化事件
            document.getElementById('patient-age').addEventListener('input', function() {
                age = parseFloat(this.value) || 0;
            });
            
            // 分析按钮点击事件
            document.getElementById('analyze-btn').addEventListener('click', analyzeVisualFunction);
            
            // 打印报告按钮事件
            document.getElementById('print-report-btn').addEventListener('click', printReport);
            
            // 保存报告按钮事件
            document.getElementById('save-report-btn').addEventListener('click', saveReportAsText);
            
            // 免责声明事件监听
            disclaimerLink.addEventListener('click', function(e) {
                e.preventDefault();
                showDisclaimer();
            });
            
            bottomDisclaimerLink.addEventListener('click', function(e) {
                e.preventDefault();
                showDisclaimer();
            });
            
            closeDisclaimerBtn.addEventListener('click', hideDisclaimer);
            agreeDisclaimerBtn.addEventListener('click', hideDisclaimer);
            printDisclaimerBtn.addEventListener('click', printDisclaimer);
            
            // 点击模态框外部关闭
            disclaimerModal.addEventListener('click', function(e) {
                if (e.target === disclaimerModal) {
                    hideDisclaimer();
                }
            });
            
            // 初始更新AC/A范围提示
            updateACARange();
        });
        
        // 显示免责声明
        function showDisclaimer() {
            disclaimerModal.classList.add('show');
            document.body.style.overflow = 'hidden'; // 防止背景滚动
        }
        
        // 隐藏免责声明
        function hideDisclaimer() {
            disclaimerModal.classList.remove('show');
            document.body.style.overflow = 'auto'; // 恢复滚动
        }
        
        // 打印免责声明
        function printDisclaimer() {
            // 创建一个打印专用的iframe
            const printFrame = document.createElement('iframe');
            printFrame.style.position = 'absolute';
            printFrame.style.width = '0';
            printFrame.style.height = '0';
            printFrame.style.border = 'none';
            document.body.appendChild(printFrame);
            
            const printDocument = printFrame.contentWindow.document;
            
            // 构建打印内容
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>免责声明 - 视功能检查分析工具</title>
                    <style>
                        body { font-family: 'Microsoft YaHei', sans-serif; line-height: 1.6; color: #333; padding: 20px; }
                        h1 { color: #1a73e8; border-bottom: 2px solid #1a73e8; padding-bottom: 10px; }
                        h2 { color: #0d47a1; border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-top: 25px; }
                        .highlight { background-color: #fff8e1; padding: 15px; border-left: 4px solid #ff9800; margin: 15px 0; }
                        ul { margin-left: 20px; }
                        li { margin-bottom: 8px; }
                        .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 0.9rem; color: #666; }
                        @media print {
                            body { font-size: 12pt; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <h1>免责声明 - 视功能检查分析工具</h1>
                    <p>最后更新日期：2026年12月29日</p>
                    
                    <h2>1. 工具性质</h2>
                    <p>本视功能检查分析工具（以下简称"本工具"）是一款基于输入数据进行自动化分析的辅助工具，旨在为视功能检查提供参考性分析结果。本工具不能替代专业眼科医师的诊断和治疗建议。</p>
                    
                    <h2>2. 非医疗建议</h2>
                    <p>本工具生成的分析结果、诊断建议和训练方案仅为基于算法逻辑的参考信息，不具有医疗诊断效力。所有视觉功能相关问题的最终诊断和治疗方案应由具备相应资质的眼科医师或视光师根据实际检查结果确定。</p>
                    <div class="highlight">
                        <p><strong>重要提醒：</strong>如果您或患者有任何视觉不适、视力下降、眼痛、复视等症状，请立即前往正规医疗机构就诊，切勿仅依赖本工具的分析结果进行自我诊断或治疗。</p>
                    </div>
                    
                    <h2>3. 数据准确性</h2>
                    <p>本工具的分析结果完全依赖于用户输入的数据准确性。任何输入错误或不完整的数据都可能导致分析结果不准确或不适用。用户应确保：</p>
                    <ul>
                        <li>输入数据来自规范的视功能检查流程</li>
                        <li>检查结果由专业人员测量获得</li>
                        <li>数据单位正确无误（如屈光度、棱镜度等）</li>
                        <li>患者的年龄、病史等基本信息准确无误</li>
                    </ul>
                    
                    <h2>4. 责任限制</h2>
                    <p>本工具的开发者和提供者对以下情况不承担任何责任：</p>
                    <ul>
                        <li>因使用本工具分析结果而导致的任何直接或间接损失</li>
                        <li>因输入数据错误或不完整导致的分析结果偏差</li>
                        <li>用户根据本工具建议采取行动而产生的任何后果</li>
                        <li>因技术问题导致的服务中断、数据丢失等情况</li>
                        <li>任何第三方基于本工具结果做出的决策或行动</li>
                    </ul>
                    
                    <h2>5. 数据隐私</h2>
                    <p>本工具在浏览器本地运行，所有输入数据仅保存在您的设备中，不会上传到任何服务器。但请注意：</p>
                    <ul>
                        <li>如果您在公共设备上使用本工具，使用后请清除浏览器缓存</li>
                        <li>建议不要在工具中输入患者的完整身份证号等敏感信息</li>
                        <li>对于患者隐私数据的保护，您仍需遵守相关法律法规</li>
                    </ul>
                    
                    <h2>6. 知识产权</h2>
                    <p>本工具及其相关算法、界面设计、分析逻辑等均受知识产权法保护。未经明确授权，任何个人或组织不得：</p>
                    <ul>
                        <li>对本工具进行反向工程、反编译或分解</li>
                        <li>未经许可复制、修改或分发本工具</li>
                        <li>将本工具用于商业目的而未经授权</li>
                        <li>声称对本工具拥有所有权或开发权</li>
                    </ul>
                    
                    <h2>7. 使用同意</h2>
                    <p>使用本工具即表示您已阅读、理解并同意本免责声明的所有条款。如果您不同意任何条款，请立即停止使用本工具。</p>
                    <p>本免责声明可能会不定期更新，建议您定期查看以了解最新条款。</p>
                    
                    <div class="footer">
                        <p>© 2026 视功能检查分析工具</p>
                        <p>本工具生成的结果仅供参考，不能替代专业医疗建议</p>
                    </div>
                    
                    <div class="no-print">
                        <button onclick="window.print()">打印</button>
                        <button onclick="window.close()">关闭</button>
                    </div>
                </body>
                </html>
            `;
            
            printDocument.open();
            printDocument.write(printContent);
            printDocument.close();
            
            // 延迟打印以确保内容加载完成
            setTimeout(() => {
                printFrame.contentWindow.focus();
                printFrame.contentWindow.print();
                
                // 打印完成后移除iframe
                setTimeout(() => {
                    document.body.removeChild(printFrame);
                }, 1000);
            }, 500);
        }
        
        // 初始化输入框格式化
        function initInputFormatting() {
            // 调节功能检查输入框格式化（改为type="text"以便更好控制显示）
            const diopterInputs = ['nra', 'pra', 'bcc', 'amp-od', 'amp-os'];
            
            diopterInputs.forEach(id => {
                const input = document.getElementById(id);
                
                input.addEventListener('input', function() {
                    // 实时显示输入的值
                    let value = this.value;
                    
                    // 允许输入数字、小数点、正负号
                    value = value.replace(/[^0-9.\+\-]/g, '');
                    
                    // 确保只有一个符号
                    const hasPlus = value.includes('+');
                    const hasMinus = value.includes('-');
                    
                    if (hasPlus && hasMinus) {
                        // 如果同时有正负号，保留最后一个
                        const lastPlusIndex = value.lastIndexOf('+');
                        const lastMinusIndex = value.lastIndexOf('-');
                        
                        if (lastPlusIndex > lastMinusIndex) {
                            value = '+' + value.replace(/[+-]/g, '');
                        } else {
                            value = '-' + value.replace(/[+-]/g, '');
                        }
                    } else if (hasPlus) {
                        value = '+' + value.replace('+', '');
                    } else if (hasMinus) {
                        value = '-' + value.replace('-', '');
                    }
                    
                    this.value = value;
                });
                
                input.addEventListener('blur', function() {
                    let value = this.value.trim();
                    
                    // 如果为空，不处理
                    if (value === '') return;
                    
                    // 确保有符号，如果没有，添加正号
                    if (!value.startsWith('+') && !value.startsWith('-')) {
                        value = '+' + value;
                    }
                    
                    // 转换为数字并检查是否为0.25的倍数
                    let numValue = parseFloat(value);
                    if (isNaN(numValue)) {
                        this.value = '';
                        return;
                    }
                    
                    // 四舍五入到最接近的0.25
                    numValue = Math.round(numValue * 4) / 4;
                    
                    // 格式化为两位小数
                    this.value = numValue.toFixed(2);
                    
                    // 确保有符号
                    if (this.value[0] !== '+' && this.value[0] !== '-') {
                        this.value = (numValue >= 0 ? '+' : '') + this.value;
                    }
                });
            });
            
            // 整数输入框格式化
            const integerInputs = document.querySelectorAll('input[type="number"]');
            integerInputs.forEach(input => {
                input.addEventListener('blur', function() {
                    let value = this.value.trim();
                    
                    // 如果为空，不处理
                    if (value === '') return;
                    
                    // 转换为整数
                    let intValue = parseInt(value);
                    if (isNaN(intValue)) {
                        this.value = '';
                        return;
                    }
                    
                    // 确保是整数
                    this.value = intValue.toString();
                });
            });
        }
        
        // 更新AC/A范围提示
        function updateACARange() {
            const typeSelect = document.getElementById('aca-type');
            const rangeHint = document.getElementById('aca-range');
            
            if (typeSelect.value === 'calculated') {
                rangeHint.innerHTML = '正常范围: 4~7 △/D';
                rangeHint.className = 'range-hint';
            } else if (typeSelect.value === 'gradient') {
                rangeHint.innerHTML = '正常范围: 3~5 △/D';
                rangeHint.className = 'range-hint';
            } else {
                rangeHint.innerHTML = '正常范围: 选择类型后显示';
                rangeHint.className = 'range-hint';
            }
        }
        
        // 检查眼位异常（按照您提供的逻辑流程）
        function checkPhoriaAbnormalities() {
            const pd = parseFloat(document.getElementById('pd').value);
            const pn = parseFloat(document.getElementById('pn').value);
            
            phoriaAbnormalities = [];
            requiredFusionFields = [];
            problemEyePositions = [];
            const alertBox = document.getElementById('phoria-alert');
            const detailsDiv = document.getElementById('phoria-details');
            const listDiv = document.getElementById('required-fusion-list');
            
            // 清空之前的内容
            detailsDiv.innerHTML = '';
            listDiv.innerHTML = '';
            
            // 如果两个眼位值都为空，隐藏提示
            if (isNaN(pd) && isNaN(pn)) {
                alertBox.classList.remove('show');
                
                // 移除所有必填标记
                document.querySelectorAll('.fusion-inputs input').forEach(input => {
                    input.classList.remove('required-field');
                });
                
                return;
            }
            
            // 如果只有一个值，无法判断异常
            if (isNaN(pd) || isNaN(pn)) {
                alertBox.classList.remove('show');
                return;
            }
            
            // 第一步：确定问题眼位（判断是散开问题还是集合问题）
            // 正常范围：远眼位(D): +1 ~ -3，近眼位(N): 0 ~ -6
            
            // 判断眼位是否超出正常范围
            const pdIsNormal = pd >= -3 && pd <= 1;
            const pnIsNormal = pn >= -6 && pn <= 0;
            
            let problemType = null; // 'divergence' 散开问题 or 'convergence' 集合问题
            let deviationPD = 0;
            let deviationPN = 0;
            
            // 计算眼位偏离正常边界的绝对值
            if (pd > 1) { // 远内隐斜超出正常范围
                deviationPD = pd - 1; // 正值，表示超出多少
            } else if (pd < -3) { // 远外隐斜超出正常范围
                deviationPD = Math.abs(pd + 3); // 正值，表示超出多少
            }
            
            if (pn > 0) { // 近内隐斜超出正常范围
                deviationPN = pn - 0; // 正值，表示超出多少
            } else if (pn < -6) { // 近外隐斜超出正常范围
                deviationPN = Math.abs(pn + 6); // 正值，表示超出多少
            }
            
            // 判断问题类型
            if (!pdIsNormal && pnIsNormal) {
                // 仅远眼位超出正常范围 → 判断为散开问题
                problemType = 'divergence';
                problemEyePositions.push('远眼位');
            } else if (pdIsNormal && !pnIsNormal) {
                // 仅近眼位超出正常范围 → 判断为集合问题
                problemType = 'convergence';
                problemEyePositions.push('近眼位');
            } else if (!pdIsNormal && !pnIsNormal) {
                // 两者均超出正常范围 → 计算各自偏离正常边界的绝对值，取偏离更大的眼位作为主要问题
                if (deviationPD > deviationPN) {
                    problemType = 'divergence';
                    problemEyePositions.push('远眼位');
                } else if (deviationPN > deviationPD) {
                    problemType = 'convergence';
                    problemEyePositions.push('近眼位');
                } else {
                    // 偏离值相等，无法确定主要问题
                    problemType = null;
                    problemEyePositions.push('远眼位', '近眼位');
                }
            } else {
                // 两者均在正常范围内 → 仍可进行第二步的差值判断
                problemType = null;
            }
            
            // 第二步：根据问题类型，应用差值阈值判断具体异常
            // 计算两个代数差值
            const nMinusD = pn - pd;
            const dMinusN = pd - pn;
            
            if (problemType === 'divergence') {
                // 散开问题
                if (nMinusD > 10) {
                    phoriaAbnormalities.push('散开过度');
                    requiredFusionFields.push('far-bo');
                } else if (dMinusN > 10) {
                    phoriaAbnormalities.push('散开不足');
                    requiredFusionFields.push('far-bi');
                }
            } else if (problemType === 'convergence') {
                // 集合问题
                if (dMinusN > 4) {
                    phoriaAbnormalities.push('集合不足');
                    requiredFusionFields.push('near-bo');
                } else if (nMinusD > 3) {
                    phoriaAbnormalities.push('集合过度');
                    requiredFusionFields.push('near-bi');
                }
            } else if (problemType === null && pdIsNormal && pnIsNormal) {
                // 两者均在正常范围内，但仍可进行差值判断
                // 散开过度/不足的判断
                if (nMinusD > 10) {
                    phoriaAbnormalities.push('散开过度(眼位在正常范围内)');
                } else if (dMinusN > 10) {
                    phoriaAbnormalities.push('散开不足(眼位在正常范围内)');
                }
                
                // 集合不足/过度的判断
                if (dMinusN > 4) {
                    phoriaAbnormalities.push('集合不足(眼位在正常范围内)');
                } else if (nMinusD > 3) {
                    phoriaAbnormalities.push('集合过度(眼位在正常范围内)');
                }
            }
            
            // 第三步：保留基本隐斜视的判断（与您的流程不冲突）
            // 基本型外隐斜：两个都是外隐斜且相差4△以内
            if (pd < 0 && pn < 0 && Math.abs(Math.abs(pd) - Math.abs(pn)) <= 4) {
                // 检查是否已经判断为散开问题，如果没有则添加基本型外隐斜
                const hasDivergenceProblem = phoriaAbnormalities.some(item => 
                    item.includes('散开过度') || item.includes('散开不足')
                );
                if (!hasDivergenceProblem) {
                    phoriaAbnormalities.push('基本型外隐斜');
                    requiredFusionFields.push('far-bo');
                    requiredFusionFields.push('near-bo');
                }
            }
            
            // 基本型内隐斜：两个都是内隐斜且相差4△以内
            if (pd > 0 && pn > 0 && Math.abs(pd - pn) <= 4) {
                // 检查是否已经判断为集合问题，如果没有则添加基本型内隐斜
                const hasConvergenceProblem = phoriaAbnormalities.some(item => 
                    item.includes('集合不足') || item.includes('集合过度')
                );
                if (!hasConvergenceProblem) {
                    phoriaAbnormalities.push('基本型内隐斜');
                    requiredFusionFields.push('far-bi');
                    requiredFusionFields.push('near-bi');
                }
            }
            
            // 第四步：检查不符合上面所有情况的单独眼位异常
            // 这些是既不是散开/集合问题，也不是基本型隐斜的情况
            if (phoriaAbnormalities.length === 0) {
                // 检查单独的眼位异常
                if (!pdIsNormal && pnIsNormal) {
                    // 只有远眼位异常
                    if (pd > 1) {
                        phoriaAbnormalities.push('远距离内隐斜');
                        requiredFusionFields.push('far-bi');
                    } else if (pd < -3) {
                        phoriaAbnormalities.push('远距离外隐斜');
                        requiredFusionFields.push('far-bo');
                    }
                } else if (pdIsNormal && !pnIsNormal) {
                    // 只有近眼位异常
                    if (pn > 0) {
                        phoriaAbnormalities.push('近距离内隐斜');
                        requiredFusionFields.push('near-bi');
                    } else if (pn < -6) {
                        phoriaAbnormalities.push('近距离外隐斜');
                        requiredFusionFields.push('near-bo');
                    }
                } else if (!pdIsNormal && !pnIsNormal) {
                    // 两个眼位都异常，但不符合散开/集合问题，也不符合基本型隐斜
                    // 这里我们分别处理每个异常眼位
                    if (pd > 1) {
                        phoriaAbnormalities.push('远距离内隐斜');
                        requiredFusionFields.push('far-bi');
                    } else if (pd < -3) {
                        phoriaAbnormalities.push('远距离外隐斜');
                        requiredFusionFields.push('far-bo');
                    }
                    
                    if (pn > 0) {
                        phoriaAbnormalities.push('近距离内隐斜');
                        if (!requiredFusionFields.includes('near-bi')) {
                            requiredFusionFields.push('near-bi');
                        }
                    } else if (pn < -6) {
                        phoriaAbnormalities.push('近距离外隐斜');
                        if (!requiredFusionFields.includes('near-bo')) {
                            requiredFusionFields.push('near-bo');
                        }
                    }
                }
            }
            
            // 去重问题眼位
            problemEyePositions = [...new Set(problemEyePositions)];
            
            // 如果有异常，显示提示
            if (phoriaAbnormalities.length > 0) {
                // 构建异常详情
                let detailsText = `<p>检测到：${phoriaAbnormalities.join('、')}</p>`;
                
                if (problemEyePositions.length > 0) {
                    detailsText += `<p>问题眼位：${problemEyePositions.join('、')}</p>`;
                }
                
                detailsDiv.innerHTML = detailsText;
                
                // 构建必填字段列表
                requiredFusionFields.forEach(field => {
                    let fieldName = '';
                    switch(field) {
                        case 'far-bo': fieldName = '远距离BO融像范围'; break;
                        case 'far-bi': fieldName = '远距离BI融像范围'; break;
                        case 'near-bo': fieldName = '近距离BO融像范围'; break;
                        case 'near-bi': fieldName = '近距离BI融像范围'; break;
                    }
                    listDiv.innerHTML += `<li>${fieldName}</li>`;
                });
                
                alertBox.classList.add('show');
                
                // 标记必填字段
                markRequiredFusionFields();
            } else {
                alertBox.classList.remove('show');
                
                // 移除所有必填标记
                document.querySelectorAll('.fusion-inputs input').forEach(input => {
                    input.classList.remove('required-field');
                });
            }
        }
        
        // 标记必填的融像范围字段
        function markRequiredFusionFields() {
            // 先移除所有错误标记
            document.querySelectorAll('.fusion-inputs input').forEach(input => {
                input.classList.remove('required-field');
            });
            
            // 根据必填字段添加错误标记
            requiredFusionFields.forEach(field => {
                let inputIds = [];
                switch(field) {
                    case 'far-bo':
                        inputIds = ['far-bo-blur', 'far-bo-break', 'far-bo-recovery'];
                        break;
                    case 'far-bi':
                        inputIds = ['far-bi-blur', 'far-bi-break', 'far-bi-recovery'];
                        break;
                    case 'near-bo':
                        inputIds = ['near-bo-blur', 'near-bo-break', 'near-bo-recovery'];
                        break;
                    case 'near-bi':
                        inputIds = ['near-bi-blur', 'near-bi-break', 'near-bi-recovery'];
                        break;
                }
                
                inputIds.forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.classList.add('required-field');
                    }
                });
            });
        }
        
        // 验证必填字段
        function validateRequiredFields() {
            let isValid = true;
            
            // 清除所有错误提示
            document.querySelectorAll('.error-message').forEach(el => {
                el.classList.remove('show');
            });
            
            // 年龄验证
            const ageInput = document.getElementById('patient-age');
            if (!ageInput.value.trim()) {
                document.getElementById('age-error').classList.add('show');
                isValid = false;
            }
            
            // 调节功能检查验证
            const accommodationFields = [
                {id: 'nra', error: 'nra-error'},
                {id: 'pra', error: 'pra-error'},
                {id: 'bcc', error: 'bcc-error'},
                {id: 'amp-od', error: 'amp-od-error'},
                {id: 'amp-os', error: 'amp-os-error'}
            ];
            
            accommodationFields.forEach(field => {
                const input = document.getElementById(field.id);
                if (!input.value.trim()) {
                    document.getElementById(field.error).classList.add('show');
                    isValid = false;
                }
            });
            
            // 集合功能检查验证
            const vergenceFields = [
                {id: 'pd', error: 'pd-error'},
                {id: 'pn', error: 'pn-error'},
                {id: 'aca-type', error: 'aca-type-error'},
                {id: 'aca-value', error: 'aca-value-error'},
                {id: 'npc', error: 'npc-error'}
            ];
            
            vergenceFields.forEach(field => {
                const input = document.getElementById(field.id);
                if (!input.value.trim()) {
                    document.getElementById(field.error).classList.add('show');
                    isValid = false;
                }
            });
            
            // 翻转拍检查验证（已更新为左右眼）
            const flipperFields = [
                {id: 'monocular-cpm-od', error: 'monocular-cpm-od-error'},
                {id: 'monocular-flipper-od', error: 'monocular-flipper-od-error'},
                {id: 'monocular-cpm-os', error: 'monocular-cpm-os-error'},
                {id: 'monocular-flipper-os', error: 'monocular-flipper-os-error'},
                {id: 'binocular-cpm', error: 'binocular-cpm-error'},
                {id: 'binocular-flipper', error: 'binocular-flipper-error'}
            ];
            
            flipperFields.forEach(field => {
                const input = document.getElementById(field.id);
                if (!input.value.trim()) {
                    document.getElementById(field.error).classList.add('show');
                    isValid = false;
                }
            });
            
            // 验证眼位异常对应的融像范围
            if (requiredFusionFields.length > 0) {
                requiredFusionFields.forEach(field => {
                    let inputIds = [];
                    let fieldName = '';
                    
                    switch(field) {
                        case 'far-bo':
                            inputIds = ['far-bo-blur', 'far-bo-break', 'far-bo-recovery'];
                            fieldName = '远距离BO';
                            break;
                        case 'far-bi':
                            inputIds = ['far-bi-blur', 'far-bi-break', 'far-bi-recovery'];
                            fieldName = '远距离BI';
                            break;
                        case 'near-bo':
                            inputIds = ['near-bo-blur', 'near-bo-break', 'near-bo-recovery'];
                            fieldName = '近距离BO';
                            break;
                        case 'near-bi':
                            inputIds = ['near-bi-blur', 'near-bi-break', 'near-bi-recovery'];
                            fieldName = '近距离BI';
                            break;
                    }
                    
                    // 检查每个必填融像范围是否已填写
                    let fieldFilled = true;
                    inputIds.forEach(id => {
                        const input = document.getElementById(id);
                        if (!input.value.trim()) {
                            fieldFilled = false;
                        }
                    });
                    
                    if (!fieldFilled) {
                        isValid = false;
                        // 显示警告
                        alert(`检测到眼位异常，必须填写${fieldName}融像范围`);
                    }
                });
            }
            
            return isValid;
        }
        
        // 分析视功能
        function analyzeVisualFunction() {
            // 验证必填字段
            if (!validateRequiredFields()) {
                alert('请填写所有必填字段！');
                return;
            }
            
            // 显示加载动画
            document.getElementById('loader').classList.add('show');
            document.getElementById('analyze-btn').disabled = true;
            
            // 短暂延迟后显示结果（模拟分析过程）
            setTimeout(() => {
                performAnalysis();
                document.getElementById('loader').classList.remove('show');
                document.getElementById('analyze-btn').disabled = false;
            }, 800);
        }
        
        // 执行分析
        function performAnalysis() {
            // 获取患者信息
            const patientName = document.getElementById('patient-name').value || '未填写';
            age = parseFloat(document.getElementById('patient-age').value) || 0;
            
            // 设置患者信息
            document.getElementById('result-name').textContent = patientName;
            document.getElementById('result-age').textContent = age;
            
            // 设置当前日期
            const now = new Date();
            const dateStr = now.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            document.getElementById('result-date').textContent = dateStr;
            
            // 分析调节功能
            analyzeAccommodation();
            
            // 分析集合功能
            analyzeVergence();
            
            // 分析翻转拍检查
            analyzeFlipper();
            
            // 生成综合诊断与训练方案
            generateFinalDiagnosisAndTrainingPlan();
            
            // 显示结果区域
            document.getElementById('results').classList.add('show');
            
            // 滚动到结果区域
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }
        
        // 分析调节功能
        function analyzeAccommodation() {
            const resultsDiv = document.getElementById('accommodation-results');
            resultsDiv.innerHTML = '';
            
            // 获取输入值
            const nra = parseFloat(document.getElementById('nra').value);
            const pra = parseFloat(document.getElementById('pra').value);
            const bcc = parseFloat(document.getElementById('bcc').value);
            const ampOd = parseFloat(document.getElementById('amp-od').value);
            const ampOs = parseFloat(document.getElementById('amp-os').value);
            
            // 计算最小调节幅度
            const minAmp = 15 - (age * 0.25);
            
            // 分析NRA
            if (!isNaN(nra)) {
                let status = 'normal';
                let diagnosis = '';
                
                if (nra < 0) {
                    status = 'abnormal';
                    diagnosis = 'NRA为负值，数据异常';
                } else if (nra > 0 && nra < 1.5) {
                    status = 'abnormal';
                    diagnosis = 'NRA偏低，提示调节过度或正融像性聚散不足';
                } else if (nra >= 1.5 && nra <= 2.5) {
                    status = 'normal';
                    diagnosis = '正常';
                } else if (nra > 2.5) {
                    status = 'abnormal';
                    diagnosis = 'NRA偏高，可能验光不准确';
                }
                
                addResultItem(resultsDiv, 'NRA', formatDiopter(nra), status, diagnosis);
            }
            
            // 分析PRA
            if (!isNaN(pra)) {
                let status = 'normal';
                let diagnosis = '';
                
                if (pra > 0) {
                    status = 'abnormal';
                    diagnosis = 'PRA为正值，数据异常';
                } else if (pra > -2.5 && pra < 0) {
                    status = 'abnormal';
                    diagnosis = 'PRA偏低，提示调节不足或负融像性聚散不足';
                } else if (pra <= -2.5) {
                    status = 'normal';
                    diagnosis = '正常';
                }
                
                addResultItem(resultsDiv, 'PRA', formatDiopter(pra), status, diagnosis);
            }
            
            // 分析BCC
            if (!isNaN(bcc)) {
                let status = 'normal';
                let diagnosis = '';
                
                if (bcc < 0.25) {
                    status = 'abnormal';
                    diagnosis = '调节超前';
                } else if (bcc >= 0.25 && bcc <= 0.75) {
                    status = 'normal';
                    diagnosis = '正常';
                } else if (bcc > 0.75) {
                    status = 'abnormal';
                    diagnosis = '调节滞后';
                }
                
                addResultItem(resultsDiv, 'BCC', formatDiopter(bcc), status, diagnosis);
            }
            
            // 分析AMP OD
            if (!isNaN(ampOd)) {
                const status = (ampOd >= minAmp - 2) ? 'normal' : 'abnormal';
                const diagnosis = (ampOd >= minAmp - 2) ? 
                    `正常（最小调节幅度：${minAmp.toFixed(2)}D）` : 
                    `调节幅度不足（低于最小调节幅度2D以上）`;
                
                addResultItem(resultsDiv, 'AMP OD', formatDiopter(ampOd), status, diagnosis);
            }
            
            // 分析AMP OS
            if (!isNaN(ampOs)) {
                const status = (ampOs >= minAmp - 2) ? 'normal' : 'abnormal';
                const diagnosis = (ampOs >= minAmp - 2) ? 
                    `正常（最小调节幅度：${minAmp.toFixed(2)}D）` : 
                    `调节幅度不足（低于最小调节幅度2D以上）`;
                
                addResultItem(resultsDiv, 'AMP OS', formatDiopter(ampOs), status, diagnosis);
            }
            
            // 如果没有数据
            if (resultsDiv.innerHTML === '') {
                resultsDiv.innerHTML = '<p class="range-hint">未输入调节功能检查数据</p>';
            }
        }
        
        // 分析集合功能
        function analyzeVergence() {
            const resultsDiv = document.getElementById('vergence-results');
            resultsDiv.innerHTML = '';
            
            // 获取输入值
            const pd = parseFloat(document.getElementById('pd').value);
            const pn = parseFloat(document.getElementById('pn').value);
            const acaType = document.getElementById('aca-type').value;
            const acaValue = parseFloat(document.getElementById('aca-value').value);
            const npc = parseFloat(document.getElementById('npc').value);
            
            // 分析远眼位
            if (!isNaN(pd)) {
                let status = 'normal';
                let diagnosis = '';
                
                if (pd >= -3 && pd <= 1) {
                    status = 'normal';
                    diagnosis = '正常';
                } else if (pd > 1) {
                    status = 'abnormal';
                    diagnosis = '远距离内隐斜';
                } else if (pd < -3) {
                    status = 'abnormal';
                    diagnosis = '远距离外隐斜';
                }
                
                addResultItem(resultsDiv, '远眼位 (PD)', formatPrism(pd), status, diagnosis);
            }
            
            // 分析近眼位
            if (!isNaN(pn)) {
                let status = 'normal';
                let diagnosis = '';
                
                if (pn >= -6 && pn <= 0) {
                    status = 'normal';
                    diagnosis = '正常';
                } else if (pn > 0) {
                    status = 'abnormal';
                    diagnosis = '近距离内隐斜';
                } else if (pn < -6) {
                    status = 'abnormal';
                    diagnosis = '近距离外隐斜';
                }
                
                addResultItem(resultsDiv, '近眼位 (PN)', formatPrism(pn), status, diagnosis);
            }
            
            // 分析AC/A
            if (!isNaN(acaValue) && acaType) {
                let status = 'normal';
                let diagnosis = '';
                let normalMin, normalMax;
                
                if (acaType === 'calculated') {
                    normalMin = 4;
                    normalMax = 7;
                } else {
                    normalMin = 3;
                    normalMax = 5;
                }
                
                if (acaValue >= normalMin && acaValue <= normalMax) {
                    status = 'normal';
                    diagnosis = '正常';
                } else if (acaValue < normalMin) {
                    status = 'abnormal';
                    diagnosis = 'AC/A偏低，提示调节性集合不足';
                } else if (acaValue > normalMax) {
                    status = 'abnormal';
                    diagnosis = 'AC/A偏高，提示调节性集合过度';
                }
                
                const typeText = acaType === 'calculated' ? '计算性' : '梯度性';
                addResultItem(resultsDiv, `${typeText} AC/A`, `${acaValue.toFixed(1)} △/D`, status, diagnosis);
            }
            
            // 分析NPC
            if (!isNaN(npc)) {
                const status = (npc >= 0 && npc <= 7) ? 'normal' : 'abnormal';
                const diagnosis = (npc >= 0 && npc <= 7) ? 
                    '正常' : 'NPC大于7cm，提示集合不足';
                
                addResultItem(resultsDiv, '集合近点 (NPC)', `${npc.toFixed(1)} cm`, status, diagnosis);
            }
            
            // 分析融像范围
            analyzeFusionRanges(resultsDiv);
            
            // 分析棱镜补偿
            analyzePrismCompensation(resultsDiv);
            
            // 如果没有数据
            if (resultsDiv.innerHTML === '') {
                resultsDiv.innerHTML = '<p class="range-hint">未输入集合功能检查数据</p>';
            }
        }
        
        // 分析融像范围
        function analyzeFusionRanges(resultsDiv) {
            // 远BI
            const farBiBlur = parseFloat(document.getElementById('far-bi-blur').value);
            const farBiBreak = parseFloat(document.getElementById('far-bi-break').value);
            const farBiRecovery = parseFloat(document.getElementById('far-bi-recovery').value);
            
            if (!isNaN(farBiBreak)) {
                let status = 'normal';
                let diagnosis = '';
                
                if (farBiBreak >= 4 && farBiBreak <= 10) {
                    status = 'normal';
                    diagnosis = '破裂点正常';
                } else if (farBiBreak < 4) {
                    status = 'abnormal';
                    diagnosis = '破裂点低于正常范围，提示融像范围过低';
                } else if (farBiBreak > 10) {
                    status = 'abnormal';
                    diagnosis = '破裂点高于正常范围，提示融像范围过高';
                }
                
                addResultItem(resultsDiv, '远BI破裂点', formatPrism(farBiBreak), status, diagnosis);
            }
            
            // 远BO
            const farBoBlur = parseFloat(document.getElementById('far-bo-blur').value);
            const farBoBreak = parseFloat(document.getElementById('far-bo-break').value);
            const farBoRecovery = parseFloat(document.getElementById('far-bo-recovery').value);
            
            if (!isNaN(farBoBlur)) {
                let status = 'normal';
                let diagnosis = '';
                
                if (farBoBlur >= 5 && farBoBlur <= 13) {
                    status = 'normal';
                    diagnosis = '模糊点正常';
                } else if (farBoBlur < 5) {
                    status = 'abnormal';
                    diagnosis = '模糊点低于正常范围，提示融像范围过低';
                } else if (farBoBlur > 13) {
                    status = 'abnormal';
                    diagnosis = '模糊点高于正常范围，提示融像范围过高';
                }
                
                addResultItem(resultsDiv, '远BO模糊点', formatPrism(farBoBlur), status, diagnosis);
            }
            
            // 近BI
            const nearBiBreak = parseFloat(document.getElementById('near-bi-break').value);
            
            if (!isNaN(nearBiBreak)) {
                let status = 'normal';
                let diagnosis = '';
                
                if (nearBiBreak >= 17 && nearBiBreak <= 25) {
                    status = 'normal';
                    diagnosis = '破裂点正常';
                } else if (nearBiBreak < 17) {
                    status = 'abnormal';
                    diagnosis = '破裂点低于正常范围，提示融像范围过低';
                } else if (nearBiBreak > 25) {
                    status = 'abnormal';
                    diagnosis = '破裂点高于正常范围，提示融像范围过高';
                }
                
                addResultItem(resultsDiv, '近BI破裂点', formatPrism(nearBiBreak), status, diagnosis);
            }
            
            // 近BO
            const nearBoBlur = parseFloat(document.getElementById('near-bo-blur').value);
            
            if (!isNaN(nearBoBlur)) {
                let status = 'normal';
                let diagnosis = '';
                
                if (nearBoBlur >= 12 && nearBoBlur <= 22) {
                    status = 'normal';
                    diagnosis = '模糊点正常';
                } else if (nearBoBlur < 12) {
                    status = 'abnormal';
                    diagnosis = '模糊点低于正常范围，提示融像范围过低';
                } else if (nearBoBlur > 22) {
                    status = 'abnormal';
                    diagnosis = '模糊点高于正常范围，提示融像范围过高';
                }
                
                addResultItem(resultsDiv, '近BO模糊点', formatPrism(nearBoBlur), status, diagnosis);
            }
        }
        
        // 分析棱镜补偿 - 修改了1:1法则的判断条件
        function analyzePrismCompensation(resultsDiv) {
            const pd = parseFloat(document.getElementById('pd').value);
            const pn = parseFloat(document.getElementById('pn').value);
            const farBiRecovery = parseFloat(document.getElementById('far-bi-recovery').value);
            const farBoBlur = parseFloat(document.getElementById('far-bo-blur').value);
            const nearBiRecovery = parseFloat(document.getElementById('near-bi-recovery').value);
            const nearBoBlur = parseFloat(document.getElementById('near-bo-blur').value);
            
            // 远眼位内隐斜对应远融像BI恢复点 - 修改为1倍
            if (!isNaN(pd) && pd > 1 && !isNaN(farBiRecovery)) {
                if (farBiRecovery >= Math.abs(pd)) { // 修改为1倍
                    addResultItem(resultsDiv, '远眼位内隐斜-远BI恢复点', '满足1:1法则', 'normal', 'BI恢复点数值不低于隐斜量1△，适用1:1法则'); // 修改提示文字
                } else {
                    addResultItem(resultsDiv, '远眼位内隐斜-远BI恢复点', '不满足1:1法则', 'abnormal', 'BI恢复点数值低于隐斜量1△，不适用1:1法则'); // 修改提示文字
                    
                    // 建议棱镜补偿
                    let prism = '';
                    if (pd >= 3 && pd <= 5) {
                        prism = `建议配戴${(pd/3).toFixed(1)}△ BO缓解棱镜`;
                    } else if (pd >= 6) {
                        prism = `建议配戴${(pd/2).toFixed(1)}△ BO缓解棱镜`;
                    }
                    if (prism) {
                        addResultItem(resultsDiv, '棱镜补偿建议', prism, 'abnormal', prism);
                    }
                }
            }
            
            // 远眼位外隐斜对应远融像BO模糊点 - 谢尔德法则保持不变
            if (!isNaN(pd) && pd < -3 && !isNaN(farBoBlur)) {
                if (Math.abs(farBoBlur) >= Math.abs(pd) * 2) {
                    addResultItem(resultsDiv, '远眼位外隐斜-远BO模糊点', '满足谢尔德法则', 'normal', 'BO模糊点数值≥外隐斜量的2倍，适用谢尔德法则');
                } else {
                    addResultItem(resultsDiv, '远眼位外隐斜-远BO模糊点', '不满足谢尔德法则', 'abnormal', 'BO模糊点数值＜外隐斜量的2倍，不适用谢尔德法则');
                    
                    // 计算棱镜量
                    const prism = (2/3 * Math.abs(pd)) - (1/3 * Math.abs(farBoBlur));
                    if (prism > 0) {
                        addResultItem(resultsDiv, '棱镜补偿建议', `建议配戴${prism.toFixed(1)}△ BI缓解棱镜`, 'abnormal', `BI棱镜量=(2/3×${Math.abs(pd)})-(1/3×${Math.abs(farBoBlur)})=${prism.toFixed(1)}△`);
                    }
                }
            }
            
            // 近眼位内隐斜对应近融像BI恢复点 - 修改为1倍
            if (!isNaN(pn) && pn > 0 && !isNaN(nearBiRecovery)) {
                if (nearBiRecovery >= Math.abs(pn)) { // 修改为1倍
                    addResultItem(resultsDiv, '近眼位内隐斜-近BI恢复点', '满足1:1法则', 'normal', 'BI恢复点数值不低于隐斜量1△，适用1:1法则'); // 修改提示文字
                } else {
                    addResultItem(resultsDiv, '近眼位内隐斜-近BI恢复点', '不满足1:1法则', 'abnormal', 'BI恢复点数值低于隐斜量1△，不适用1:1法则'); // 修改提示文字
                    
                    // 建议棱镜补偿
                    let prism = '';
                    if (pn >= 3 && pn <= 5) {
                        prism = `建议配戴${(pn/3).toFixed(1)}△ BO缓解棱镜`;
                    } else if (pn >= 6) {
                        prism = `建议配戴${(pn/2).toFixed(1)}△ BO缓解棱镜`;
                    }
                    if (prism) {
                        addResultItem(resultsDiv, '棱镜补偿建议', prism, 'abnormal', prism);
                    }
                }
            }
            
            // 近眼位外隐斜对应近融像BO模糊点 - 谢尔德法则保持不变
            if (!isNaN(pn) && pn < -6 && !isNaN(nearBoBlur)) {
                if (Math.abs(nearBoBlur) >= Math.abs(pn) * 2) {
                    addResultItem(resultsDiv, '近眼位外隐斜-近BO模糊点', '满足谢尔德法则', 'normal', 'BO模糊点数值≥外隐斜量的2倍，适用谢尔德法则');
                } else {
                    addResultItem(resultsDiv, '近眼位外隐斜-近BO模糊点', '不满足谢尔德法则', 'abnormal', 'BO模糊点数值＜外隐斜量的2倍，不适用谢尔德法则');
                    
                    // 计算棱镜量
                    const prism = (2/3 * Math.abs(pn)) - (1/3 * Math.abs(nearBoBlur));
                    if (prism > 0) {
                        addResultItem(resultsDiv, '棱镜补偿建议', `建议配戴${prism.toFixed(1)}△ BI缓解棱镜`, 'abnormal', `BI棱镜量=(2/3×${Math.abs(pn)})-(1/3×${Math.abs(nearBoBlur)})=${prism.toFixed(1)}△`);
                    }
                }
            }
        }
        
        // 分析翻转拍检查（修正逻辑）
        function analyzeFlipper() {
            const resultsDiv = document.getElementById('flipper-results');
            resultsDiv.innerHTML = '';
            
            // 获取输入值（已更新为左右眼）
            const monocularCpmOd = parseFloat(document.getElementById('monocular-cpm-od').value);
            const monocularFlipperOd = document.getElementById('monocular-flipper-od').value;
            const monocularCpmOs = parseFloat(document.getElementById('monocular-cpm-os').value);
            const monocularFlipperOs = document.getElementById('monocular-flipper-os').value;
            const binocularCpm = parseFloat(document.getElementById('binocular-cpm').value);
            const binocularFlipper = document.getElementById('binocular-flipper').value;
            
            // 分析右眼调节灵敏度
            if (!isNaN(monocularCpmOd)) {
                const status = (monocularCpmOd >= 12) ? 'normal' : 'abnormal';
                const diagnosis = (monocularCpmOd >= 12) ? 
                    '正常' : '低于12 cpm，右眼调节灵敏度差';
                
                addResultItem(resultsDiv, '右眼调节灵敏度', `${monocularCpmOd} cpm`, status, diagnosis);
            }
            
            // 分析右眼翻转拍通过情况
            if (monocularFlipperOd) {
                let status = 'normal';
                let diagnosis = '';
                
                switch(monocularFlipperOd) {
                    case 'normal':
                        status = 'normal';
                        diagnosis = '右眼翻转拍通过正常';
                        break;
                    case 'plus-difficulty':
                        status = 'abnormal';
                        diagnosis = '正镜通过困难：提示调节过度或调节痉挛';
                        break;
                    case 'minus-difficulty':
                        status = 'abnormal';
                        diagnosis = '负镜通过困难：提示调节不足';
                        break;
                    case 'both-difficulty':
                        status = 'abnormal';
                        diagnosis = '正负镜均通过困难：提示调节灵敏度差';
                        break;
                }
                
                addResultItem(resultsDiv, '右眼翻转拍通过情况', getFlipperText(monocularFlipperOd), status, diagnosis);
            }
            
            // 分析左眼调节灵敏度
            if (!isNaN(monocularCpmOs)) {
                const status = (monocularCpmOs >= 12) ? 'normal' : 'abnormal';
                const diagnosis = (monocularCpmOs >= 12) ? 
                    '正常' : '低于12 cpm，左眼调节灵敏度差';
                
                addResultItem(resultsDiv, '左眼调节灵敏度', `${monocularCpmOs} cpm`, status, diagnosis);
            }
            
            // 分析左眼翻转拍通过情况
            if (monocularFlipperOs) {
                let status = 'normal';
                let diagnosis = '';
                
                switch(monocularFlipperOs) {
                    case 'normal':
                        status = 'normal';
                        diagnosis = '左眼翻转拍通过正常';
                        break;
                    case 'plus-difficulty':
                        status = 'abnormal';
                        diagnosis = '正镜通过困难：提示调节过度或调节痉挛';
                        break;
                    case 'minus-difficulty':
                        status = 'abnormal';
                        diagnosis = '负镜通过困难：提示调节不足';
                        break;
                    case 'both-difficulty':
                        status = 'abnormal';
                        diagnosis = '正负镜均通过困难：提示调节灵敏度差';
                        break;
                }
                
                addResultItem(resultsDiv, '左眼翻转拍通过情况', getFlipperText(monocularFlipperOs), status, diagnosis);
            }
            
            // 分析双眼调节灵敏度
            if (!isNaN(binocularCpm)) {
                const status = (binocularCpm >= 8) ? 'normal' : 'abnormal';
                const diagnosis = (binocularCpm >= 8) ? 
                    '正常' : '低于8 cpm，双眼调节灵敏度差';
                
                addResultItem(resultsDiv, '双眼调节灵敏度', `${binocularCpm} cpm`, status, diagnosis);
            }
            
            // 分析双眼翻转拍通过情况（修正逻辑）
            if (binocularFlipper) {
                let status = 'normal';
                let diagnosis = '';
                
                // 检查单眼是否异常
                const monocularPlusDifficulty = (monocularFlipperOd === 'plus-difficulty' || monocularFlipperOs === 'plus-difficulty');
                const monocularMinusDifficulty = (monocularFlipperOd === 'minus-difficulty' || monocularFlipperOs === 'minus-difficulty');
                const monocularBothDifficulty = (monocularFlipperOd === 'both-difficulty' || monocularFlipperOs === 'both-difficulty');
                const monocularNormal = (monocularFlipperOd === 'normal' && monocularFlipperOs === 'normal');
                
                switch(binocularFlipper) {
                    case 'normal':
                        status = 'normal';
                        diagnosis = '双眼翻转拍通过正常';
                        break;
                    case 'plus-difficulty':
                        // 单眼正镜通过困难 = 调节过度，双眼正镜困难也是调节过度
                        if (monocularPlusDifficulty || monocularBothDifficulty) {
                            status = 'abnormal';
                            diagnosis = '正镜通过困难：提示调节过度或调节痉挛';
                        } 
                        // 单眼正常的前提下，双眼正镜困难 = 集合不足
                        else if (monocularNormal) {
                            status = 'abnormal';
                            diagnosis = '正镜通过困难：单眼正常，双眼正镜困难提示正融像性聚散不足（集合不足）';
                        }
                        // 其他情况（比如单眼负镜困难）
                        else {
                            status = 'abnormal';
                            diagnosis = '正镜通过困难：提示调节过度或集合不足，需结合单眼检查结果判断';
                        }
                        break;
                    case 'minus-difficulty':
                        // 单眼负镜通过困难 = 调节不足，双眼负镜困难也是调节不足
                        if (monocularMinusDifficulty || monocularBothDifficulty) {
                            status = 'abnormal';
                            diagnosis = '负镜通过困难：提示调节不足';
                        }
                        // 单眼正常的前提下，双眼负镜困难 = 集合过度
                        else if (monocularNormal) {
                            status = 'abnormal';
                            diagnosis = '负镜通过困难：单眼正常，双眼负镜困难提示负融像性聚散不足（集合过度）';
                        }
                        // 其他情况（比如单眼正镜困难）
                        else {
                            status = 'abnormal';
                            diagnosis = '负镜通过困难：提示调节不足或集合过度，需结合单眼检查结果判断';
                        }
                        break;
                    case 'both-difficulty':
                        status = 'abnormal';
                        if (monocularBothDifficulty) {
                            diagnosis = '正负镜均通过困难：提示调节灵敏度差';
                        } else if (monocularPlusDifficulty && monocularMinusDifficulty) {
                            diagnosis = '正负镜均通过困难：提示调节功能障碍（可能包含调节过度和调节不足）';
                        } else if (monocularNormal) {
                            diagnosis = '正负镜均通过困难：单眼正常，提示融像性聚散功能障碍';
                        } else {
                            diagnosis = '正负镜均通过困难：提示调节和/或集合功能全面异常';
                        }
                        break;
                }
                
                addResultItem(resultsDiv, '双眼翻转拍通过情况', getFlipperText(binocularFlipper), status, diagnosis);
            }
            
            // 如果没有数据
            if (resultsDiv.innerHTML === '') {
                resultsDiv.innerHTML = '<p class="range-hint">未输入翻转拍检查数据</p>';
            }
        }
        
        // 获取翻转拍文本
        function getFlipperText(value) {
            switch(value) {
                case 'normal': return '正常通过';
                case 'plus-difficulty': return '正镜片(+2.00)通过困难';
                case 'minus-difficulty': return '负镜片(-2.00)通过困难';
                case 'both-difficulty': return '正负镜片均困难';
                default: return '';
            }
        }
        
        // 生成综合诊断与训练方案（按照新规则）
        function generateFinalDiagnosisAndTrainingPlan() {
            const containerDiv = document.getElementById('diagnosis-training-container');
            containerDiv.innerHTML = '';
            
            // 获取所有检查数据
            const nra = parseFloat(document.getElementById('nra').value);
            const pra = parseFloat(document.getElementById('pra').value);
            const bcc = parseFloat(document.getElementById('bcc').value);
            const ampOd = parseFloat(document.getElementById('amp-od').value);
            const ampOs = parseFloat(document.getElementById('amp-os').value);
            const acaType = document.getElementById('aca-type').value;
            const acaValue = parseFloat(document.getElementById('aca-value').value);
            const npc = parseFloat(document.getElementById('npc').value);
            const pd = parseFloat(document.getElementById('pd').value);
            const pn = parseFloat(document.getElementById('pn').value);
            const monocularFlipperOd = document.getElementById('monocular-flipper-od').value;
            const monocularFlipperOs = document.getElementById('monocular-flipper-os').value;
            const binocularFlipper = document.getElementById('binocular-flipper').value;
            const farBiRecovery = parseFloat(document.getElementById('far-bi-recovery').value);
            const farBoBlur = parseFloat(document.getElementById('far-bo-blur').value);
            const nearBiRecovery = parseFloat(document.getElementById('near-bi-recovery').value);
            const nearBoBlur = parseFloat(document.getElementById('near-bo-blur').value);
            
            // 计算最小调节幅度
            const minAmp = 15 - (age * 0.25);
            
            // 诊断结果数组
            const diagnoses = [];
            
            // 1. 检查调节不足
            const accommodationInsufficiency = {
                name: '调节不足',
                necessaryConditions: [],
                optionalConditions: [],
                metNecessary: false,
                optionalCount: 0
            };
            
            // 必要条件：AMP低于最小调节幅度正常值2D以上（右眼或左眼）
            const ampOdBelow = !isNaN(ampOd) && ampOd < minAmp - 2;
            const ampOsBelow = !isNaN(ampOs) && ampOs < minAmp - 2;
            const ampCondition = ampOdBelow || ampOsBelow;
            
            if (ampCondition) {
                accommodationInsufficiency.necessaryConditions.push('AMP低于最小调节幅度正常值2D以上');
                accommodationInsufficiency.metNecessary = true;
            }
            
            // 充分不必要条件
            if (monocularFlipperOd === 'minus-difficulty' || monocularFlipperOs === 'minus-difficulty') {
                accommodationInsufficiency.optionalConditions.push('翻转拍单眼负片通过困难');
                accommodationInsufficiency.optionalCount++;
            }
            
            if (!isNaN(pra) && pra > -2.5 && pra < 0) {
                accommodationInsufficiency.optionalConditions.push('PRA低于-2.50');
                accommodationInsufficiency.optionalCount++;
            }
            
            if (!isNaN(bcc) && bcc > 0.75) {
                accommodationInsufficiency.optionalConditions.push('BCC＞+0.75D');
                accommodationInsufficiency.optionalCount++;
            }
            
            if (accommodationInsufficiency.metNecessary) {
                diagnoses.push(accommodationInsufficiency);
            }
            
            // 2. 检查调节过度
            const accommodationExcess = {
                name: '调节过度',
                necessaryConditions: [],
                optionalConditions: [],
                metNecessary: false,
                optionalCount: 0
            };
            
            // 必要条件：翻转拍单眼正片通过困难
            const plusDifficulty = monocularFlipperOd === 'plus-difficulty' || monocularFlipperOs === 'plus-difficulty';
            
            if (plusDifficulty) {
                accommodationExcess.necessaryConditions.push('翻转拍单眼正片通过困难');
                accommodationExcess.metNecessary = true;
            }
            
            // 充分不必要条件
            if (!isNaN(nra) && nra < 1.5 && nra > 0) {
                accommodationExcess.optionalConditions.push('NRA低于+1.50');
                accommodationExcess.optionalCount++;
            }
            
            if (!isNaN(bcc) && bcc < 0.25) {
                accommodationExcess.optionalConditions.push('BCC＜+0.25');
                accommodationExcess.optionalCount++;
            }
            
            if (accommodationExcess.metNecessary) {
                diagnoses.push(accommodationExcess);
            }
            
            // 3. 检查调节灵活度不良
            const accommodationInfacility = {
                name: '调节灵活度不良',
                necessaryConditions: [],
                optionalConditions: [],
                metNecessary: false,
                optionalCount: 0
            };
            
            // 必要条件：翻转拍单眼正镜和负镜通过都困难
            const bothDifficultyMonocular = monocularFlipperOd === 'both-difficulty' || monocularFlipperOs === 'both-difficulty';
            
            if (bothDifficultyMonocular) {
                accommodationInfacility.necessaryConditions.push('翻转拍单眼正镜和负镜通过都困难');
                accommodationInfacility.metNecessary = true;
            }
            
            // 充分不必要条件：双眼正镜和负镜通过困难
            if (binocularFlipper === 'both-difficulty') {
                accommodationInfacility.optionalConditions.push('双眼正镜和负镜通过困难');
                accommodationInfacility.optionalCount++;
            }
            
            if (accommodationInfacility.metNecessary) {
                diagnoses.push(accommodationInfacility);
            }
            
            // 4. 检查集合不足
            const convergenceInsufficiency = {
                name: '集合不足',
                necessaryConditions: [],
                optionalConditions: [],
                metNecessary: false,
                optionalCount: 0
            };
            
            // 使用您的判断逻辑流程
            // 第一步：确定问题眼位
            const pdIsNormal = pd >= -3 && pd <= 1;
            const pnIsNormal = pn >= -6 && pn <= 0;
            
            let problemType = null;
            let deviationPD = 0;
            let deviationPN = 0;
            
            // 计算眼位偏离正常边界的绝对值
            if (pd > 1) {
                deviationPD = pd - 1;
            } else if (pd < -3) {
                deviationPD = Math.abs(pd + 3);
            }
            
            if (pn > 0) {
                deviationPN = pn - 0;
            } else if (pn < -6) {
                deviationPN = Math.abs(pn + 6);
            }
            
            // 判断问题类型
            if (!pdIsNormal && pnIsNormal) {
                problemType = 'divergence';
            } else if (pdIsNormal && !pnIsNormal) {
                problemType = 'convergence';
            } else if (!pdIsNormal && !pnIsNormal) {
                if (deviationPD > deviationPN) {
                    problemType = 'divergence';
                } else if (deviationPN > deviationPD) {
                    problemType = 'convergence';
                }
            }
            
            // 第二步：根据问题类型判断具体异常
            const nMinusD = pn - pd;
            const dMinusN = pd - pn;
            
            // 集合不足的新条件判断（根据您的要求修改）
            // 条件1：逻辑判断为"集合问题"且 (PD - PN) > 4
            const condition1 = problemType === 'convergence' && dMinusN > 4;
            
            // 条件2：NPC > 7cm
            const condition2 = !isNaN(npc) && npc > 7;
            
            // 条件3：近距离BO模糊点＜近距离眼位的2倍（修改：将≤改为＜）
            const condition3 = !isNaN(nearBoBlur) && !isNaN(pn) && pn < 0 && Math.abs(nearBoBlur) < Math.abs(pn) * 2;
            
            // 必须满足第1，且满足第2或第3任意一条
            if (condition1) {
                convergenceInsufficiency.necessaryConditions.push('逻辑判断为"集合问题"且 (PD - PN) > 4');
                
                if (condition2 || condition3) {
                    convergenceInsufficiency.metNecessary = true;
                    
                    if (condition2) {
                        convergenceInsufficiency.necessaryConditions.push('NPC > 7cm');
                    }
                    
                    if (condition3) {
                        convergenceInsufficiency.necessaryConditions.push('近距离BO模糊点＜近距离眼位的2倍');
                    }
                }
            }
            
            // 充分不必要条件（保留原有的）
            // AC/A低于正常值
            if (!isNaN(acaValue) && acaType) {
                let normalMin;
                if (acaType === 'calculated') {
                    normalMin = 4;
                } else {
                    normalMin = 3;
                }
                
                if (acaValue < normalMin) {
                    convergenceInsufficiency.optionalConditions.push('AC/A低于正常值');
                    convergenceInsufficiency.optionalCount++;
                }
            }
            
            // 翻转拍单眼正常的情况下，双眼翻转拍正镜通过困难
            const monocularNormal = (monocularFlipperOd === 'normal' && monocularFlipperOs === 'normal');
            if (monocularNormal && binocularFlipper === 'plus-difficulty') {
                convergenceInsufficiency.optionalConditions.push('翻转拍单眼正常的情况下，双眼翻转拍正镜通过困难');
                convergenceInsufficiency.optionalCount++;
            }
            
            if (convergenceInsufficiency.metNecessary) {
                diagnoses.push(convergenceInsufficiency);
            }
            
            // 5. 检查集合过度
            const convergenceExcess = {
                name: '集合过度',
                necessaryConditions: [],
                optionalConditions: [],
                metNecessary: false,
                optionalCount: 0
            };
            
            // 集合过度的新条件判断（根据您的要求修改）
            // 条件1：逻辑判断为"集合问题"且 (PN - PD) > 3
            const condition4 = problemType === 'convergence' && nMinusD > 3;
            
            // 条件2：NPC < 3cm
            const condition5 = !isNaN(npc) && npc < 3;
            
            // 条件3：近距离BI恢复点＜近距离眼位
            const condition6 = !isNaN(nearBiRecovery) && !isNaN(pn) && pn > 0 && nearBiRecovery < pn;
            
            // 必须满足第1，且满足第2或第3任意一条
            if (condition4) {
                convergenceExcess.necessaryConditions.push('逻辑判断为"集合问题"且 (PN - PD) > 3');
                
                if (condition5 || condition6) {
                    convergenceExcess.metNecessary = true;
                    
                    if (condition5) {
                        convergenceExcess.necessaryConditions.push('NPC < 3cm');
                    }
                    
                    if (condition6) {
                        convergenceExcess.necessaryConditions.push('近距离BI恢复点＜近距离眼位');
                    }
                }
            }
            
            // 充分不必要条件（保留原有的）
            // AC/A高于正常值
            if (!isNaN(acaValue) && acaType) {
                let normalMax;
                if (acaType === 'calculated') {
                    normalMax = 7;
                } else {
                    normalMax = 5;
                }
                
                if (acaValue > normalMax) {
                    convergenceExcess.optionalConditions.push('AC/A高于正常值');
                    convergenceExcess.optionalCount++;
                }
            }
            
            // 翻转拍单眼正常的情况下，双眼翻转拍负镜通过困难
            if (monocularNormal && binocularFlipper === 'minus-difficulty') {
                convergenceExcess.optionalConditions.push('翻转拍单眼正常的情况下，双眼翻转拍负镜通过困难');
                convergenceExcess.optionalCount++;
            }
            
            if (convergenceExcess.metNecessary) {
                diagnoses.push(convergenceExcess);
            }
            
            // 6. 检查散开不足
            const divergenceInsufficiency = {
                name: '散开不足',
                necessaryConditions: [],
                optionalConditions: [],
                metNecessary: false,
                optionalCount: 0
            };
            
            // 散开不足的新条件判断（根据您的要求修改）
            // 条件1：逻辑判断为"散开问题"且 (PD - PN) > 10
            const condition7 = problemType === 'divergence' && dMinusN > 10;
            
            // 条件2：远距离BO模糊点≤远距离眼位的2倍
            const condition8 = !isNaN(farBoBlur) && !isNaN(pd) && pd < 0 && Math.abs(farBoBlur) <= Math.abs(pd) * 2;
            
            // 要同时满足2条
            if (condition7 && condition8) {
                divergenceInsufficiency.necessaryConditions.push('逻辑判断为"散开问题"且 (PD - PN) > 10');
                divergenceInsufficiency.necessaryConditions.push('远距离BO模糊点≤远距离眼位的2倍');
                divergenceInsufficiency.metNecessary = true;
            }
            
            // 充分不必要条件（保留原有的）
            // 计算性AC/A低于正常值（如果用户填写梯度性AC/A，此处不参与计数）
            if (!isNaN(acaValue) && acaType === 'calculated' && acaValue < 4) {
                divergenceInsufficiency.optionalConditions.push('计算性AC/A低于正常值');
                divergenceInsufficiency.optionalCount++;
            }
            
            if (divergenceInsufficiency.metNecessary) {
                diagnoses.push(divergenceInsufficiency);
            }
            
            // 7. 检查散开过度
            const divergenceExcess = {
                name: '散开过度',
                necessaryConditions: [],
                optionalConditions: [],
                metNecessary: false,
                optionalCount: 0
            };
            
            // 散开过度的新条件判断（根据您的要求修改）
            // 条件1：逻辑判断为"散开问题"且 (PN - PD) > 10
            const condition9 = problemType === 'divergence' && nMinusD > 10;
            
            // 条件2：远距离BI恢复点＜远距离眼位
            const condition10 = !isNaN(farBiRecovery) && !isNaN(pd) && pd > 0 && farBiRecovery < pd;
            
            // 要同时满足2条
            if (condition9 && condition10) {
                divergenceExcess.necessaryConditions.push('逻辑判断为"散开问题"且 (PN - PD) > 10');
                divergenceExcess.necessaryConditions.push('远距离BI恢复点＜远距离眼位');
                divergenceExcess.metNecessary = true;
            }
            
            // 充分不必要条件（保留原有的）
            // 计算性AC/A高于正常值（如果用户填写梯度性AC/A，此处不参与计数）
            if (!isNaN(acaValue) && acaType === 'calculated' && acaValue > 7) {
                divergenceExcess.optionalConditions.push('计算性AC/A高于正常值');
                divergenceExcess.optionalCount++;
            }
            
            if (divergenceExcess.metNecessary) {
                diagnoses.push(divergenceExcess);
            }
            
            // 8. 检查基本型外隐斜（按照新逻辑修改）
            const basicExophoria = {
                name: '基本型外隐斜',
                necessaryConditions: [],
                optionalConditions: [],
                metNecessary: false,
                optionalCount: 0
            };
            
            // 必要条件：远外隐斜和近外隐斜相差4△以内
            const basicExoCondition = !isNaN(pd) && !isNaN(pn) && pd < 0 && pn < 0 && Math.abs(Math.abs(pd) - Math.abs(pn)) <= 4;
            
            if (basicExoCondition) {
                // 检查是否两个距离都满足谢尔德法则
                let farMeetSheard = false;
                let nearMeetSheard = false;
                
                // 检查远距离BO模糊点是否满足谢尔德法则（BO模糊点≥外隐斜量的2倍）
                if (!isNaN(farBoBlur)) {
                    if (Math.abs(farBoBlur) >= Math.abs(pd) * 2) {
                        farMeetSheard = true;
                    }
                }
                
                // 检查近距离BO模糊点是否满足谢尔德法则
                if (!isNaN(nearBoBlur)) {
                    if (Math.abs(nearBoBlur) >= Math.abs(pn) * 2) {
                        nearMeetSheard = true;
                    }
                }
                
                // 根据三种情况生成不同的诊断
                if (farMeetSheard && nearMeetSheard) {
                    // 情况1：远近眼位都满足融像法则（正常）
                    basicExophoria.name = '基本型外隐斜（满足对应法则，正常！）';
                    basicExophoria.necessaryConditions.push('远外隐斜和近外隐斜相差4△以内');
                    basicExophoria.necessaryConditions.push('远距离BO模糊点满足谢尔德法则');
                    basicExophoria.necessaryConditions.push('近距离BO模糊点满足谢尔德法则');
                    basicExophoria.metNecessary = true;
                } else if (!farMeetSheard && !nearMeetSheard) {
                    // 情况2：远近眼位都不满足融像法则（异常）
                    basicExophoria.name = '基本型外隐斜（远近眼位都不满足谢尔德法则）';
                    basicExophoria.necessaryConditions.push('远外隐斜和近外隐斜相差4△以内');
                    basicExophoria.necessaryConditions.push('远距离BO模糊点不满足谢尔德法则');
                    basicExophoria.necessaryConditions.push('近距离BO模糊点不满足谢尔德法则');
                    basicExophoria.metNecessary = true;
                } else {
                    // 情况3：远近眼位其中一个不满足融像法则（异常）
                    if (farMeetSheard && !nearMeetSheard) {
                        basicExophoria.name = '基本型外隐斜（远外隐斜满足谢尔德法则，近外隐斜不满足谢尔德法则）';
                        basicExophoria.necessaryConditions.push('远外隐斜和近外隐斜相差4△以内');
                        basicExophoria.necessaryConditions.push('远距离BO模糊点满足谢尔德法则');
                        basicExophoria.necessaryConditions.push('近距离BO模糊点不满足谢尔德法则');
                    } else if (!farMeetSheard && nearMeetSheard) {
                        basicExophoria.name = '基本型外隐斜（远外隐斜不满足谢尔德法则，近外隐斜满足谢尔德法则）';
                        basicExophoria.necessaryConditions.push('远外隐斜和近外隐斜相差4△以内');
                        basicExophoria.necessaryConditions.push('远距离BO模糊点不满足谢尔德法则');
                        basicExophoria.necessaryConditions.push('近距离BO模糊点满足谢尔德法则');
                    }
                    basicExophoria.metNecessary = true;
                }
            }
            
            if (basicExophoria.metNecessary) {
                diagnoses.push(basicExophoria);
            }
            
            // 9. 检查基本型内隐斜（按照新逻辑修改）
            const basicEsophoria = {
                name: '基本型内隐斜',
                necessaryConditions: [],
                optionalConditions: [],
                metNecessary: false,
                optionalCount: 0
            };
            
            // 必要条件：远内隐斜和近内隐斜相差4△以内
            const basicEsoCondition = !isNaN(pd) && !isNaN(pn) && pd > 0 && pn > 0 && Math.abs(pd - pn) <= 4;
            
            if (basicEsoCondition) {
                // 检查是否两个距离都满足1:1法则
                let farMeetOneToOne = false;
                let nearMeetOneToOne = false;
                
                // 检查远距离BI恢复点是否满足1:1法则（BI恢复点≥内隐斜量）
                if (!isNaN(farBiRecovery)) {
                    if (farBiRecovery >= pd) {
                        farMeetOneToOne = true;
                    }
                }
                
                // 检查近距离BI恢复点是否满足1:1法则
                if (!isNaN(nearBiRecovery)) {
                    if (nearBiRecovery >= pn) {
                        nearMeetOneToOne = true;
                    }
                }
                
                // 根据三种情况生成不同的诊断
                if (farMeetOneToOne && nearMeetOneToOne) {
                    // 情况1：远近眼位都满足融像法则（正常）
                    basicEsophoria.name = '基本型内隐斜（满足对应法则，正常！）';
                    basicEsophoria.necessaryConditions.push('远内隐斜和近内隐斜相差4△以内');
                    basicEsophoria.necessaryConditions.push('远距离BI恢复点满足1:1法则');
                    basicEsophoria.necessaryConditions.push('近距离BI恢复点满足1:1法则');
                    basicEsophoria.metNecessary = true;
                } else if (!farMeetOneToOne && !nearMeetOneToOne) {
                    // 情况2：远近眼位都不满足融像法则（异常）
                    basicEsophoria.name = '基本型内隐斜（远近眼位都不满足1:1法则）';
                    basicEsophoria.necessaryConditions.push('远内隐斜和近内隐斜相差4△以内');
                    basicEsophoria.necessaryConditions.push('远距离BI恢复点不满足1:1法则');
                    basicEsophoria.necessaryConditions.push('近距离BI恢复点不满足1:1法则');
                    basicEsophoria.metNecessary = true;
                } else {
                    // 情况3：远近眼位其中一个不满足融像法则（异常）
                    if (farMeetOneToOne && !nearMeetOneToOne) {
                        basicEsophoria.name = '基本型内隐斜（远内隐斜满足1:1法则，近内隐斜不满足1:1法则）';
                        basicEsophoria.necessaryConditions.push('远内隐斜和近内隐斜相差4△以内');
                        basicEsophoria.necessaryConditions.push('远距离BI恢复点满足1:1法则');
                        basicEsophoria.necessaryConditions.push('近距离BI恢复点不满足1:1法则');
                    } else if (!farMeetOneToOne && nearMeetOneToOne) {
                        basicEsophoria.name = '基本型内隐斜（远内隐斜不满足1:1法则，近内隐斜满足1:1法则）';
                        basicEsophoria.necessaryConditions.push('远内隐斜和近内隐斜相差4△以内');
                        basicEsophoria.necessaryConditions.push('远距离BI恢复点不满足1:1法则');
                        basicEsophoria.necessaryConditions.push('近距离BI恢复点满足1:1法则');
                    }
                    basicEsophoria.metNecessary = true;
                }
            }
            
            if (basicEsophoria.metNecessary) {
                diagnoses.push(basicEsophoria);
            }
            
            // 10. 检查单独的远距离/近距离眼位异常
            // 这些是既不符合散开/集合问题，也不符合基本型隐斜的情况
            // 或者即使有problemType，但也要考虑单独的眼位异常
            
            // 检查是否已经有相关的散开/集合/基本型诊断
            const hasDivergenceDiagnosis = diagnoses.some(item => 
                item.name === '散开不足' || item.name === '散开过度' ||
                item.name.includes('散开')
            );
            const hasConvergenceDiagnosis = diagnoses.some(item => 
                item.name === '集合不足' || item.name === '集合过度' ||
                item.name.includes('集合')
            );
            const hasBasicDiagnosis = diagnoses.some(item => 
                item.name === '基本型外隐斜' || item.name === '基本型内隐斜' ||
                item.name.includes('基本型')
            );
            
            // 只有当没有这些综合诊断时，才检查单独的眼位异常
            // 注意：这里的关键是，当两个眼位方向相反（一个内隐斜，一个外隐斜）时，
            // 它们不可能符合散开、集合或基本型隐斜的条件
            // 所以应该同时检查两个独立的眼位异常
            
            // 检查远距离内隐斜：需要不满足1:1法则
            if (pd > 1) {
                let notMeetOneToOne = false;
                if (!isNaN(farBiRecovery)) {
                    // 不满足1:1法则：BI恢复点 < pd
                    if (farBiRecovery < pd) {
                        notMeetOneToOne = true;
                    }
                } else {
                    // 如果没有填写远BI恢复点，我们也认为不满足法则（因为无法判断是否满足）
                    notMeetOneToOne = true;
                }
                
                // 只有在没有其他综合诊断的情况下才添加单独诊断
                if (notMeetOneToOne && !hasDivergenceDiagnosis && !hasConvergenceDiagnosis && !hasBasicDiagnosis) {
                    const farEsophoria = {
                        name: '远距离内隐斜',
                        necessaryConditions: ['远距离眼位＞1△', '不满足1:1法则'],
                        optionalConditions: [],
                        metNecessary: true,
                        optionalCount: 0
                    };
                    diagnoses.push(farEsophoria);
                }
            }
            
            // 检查近距离外隐斜：需要不满足谢尔德法则
            if (pn < -6) {
                let notMeetSheard = false;
                if (!isNaN(nearBoBlur)) {
                    // 不满足谢尔德法则：BO模糊点 < 2 * |pn|
                    if (Math.abs(nearBoBlur) < Math.abs(pn) * 2) {
                        notMeetSheard = true;
                    }
                } else {
                    // 如果没有填写近BO模糊点，我们也认为不满足法则（因为无法判断是否满足）
                    notMeetSheard = true;
                }
                
                // 只有在没有其他综合诊断的情况下才添加单独诊断
                if (notMeetSheard && !hasDivergenceDiagnosis && !hasConvergenceDiagnosis && !hasBasicDiagnosis) {
                    const nearExophoria = {
                        name: '近距离外隐斜',
                        necessaryConditions: ['近距离眼位＜-6△', '不满足谢尔德法则'],
                        optionalConditions: [],
                        metNecessary: true,
                        optionalCount: 0
                    };
                    diagnoses.push(nearExophoria);
                }
            }
            
            // 生成诊断结果
            let diagnosisHTML = '<h4>诊断结果分析</h4>';
            
            // 如果有检测到的诊断
            if (diagnoses.length > 0) {
                // 创建诊断计数表
                let tableHTML = `
                    <table class="diagnosis-count-table">
                        <thead>
                            <tr>
                                <th>诊断类型</th>
                                <th>必要条件</th>
                                <th>充分不必要条件</th>
                                <th>符合条件数</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                // 按可选条件数从高到低排序
                diagnoses.sort((a, b) => b.optionalCount - a.optionalCount);
                
                // 生成表格行
                diagnoses.forEach(diagnosis => {
                    // 根据计数确定颜色类
                    let countClass = 'count-1'; // 默认为1个（绿色）
                    if (diagnosis.optionalCount === 2) {
                        countClass = 'count-2'; // 2个（黄色）
                    } else if (diagnosis.optionalCount >= 3) {
                        // 3个或以上，根据具体数量使用不同的红色
                        if (diagnosis.optionalCount === 3) {
                            countClass = 'count-3';
                        } else if (diagnosis.optionalCount === 4) {
                            countClass = 'count-4';
                        } else {
                            countClass = 'count-5';
                        }
                    }
                    
                    const necessaryText = diagnosis.necessaryConditions.join('、');
                    const optionalText = diagnosis.optionalConditions.join('、');
                    
                    tableHTML += `
                        <tr>
                            <td>${diagnosis.name}</td>
                            <td>${necessaryText}</td>
                            <td>${optionalText || '无'}</td>
                            <td class="count-cell ${countClass}">${diagnosis.optionalCount}</td>
                        </tr>
                    `;
                });
                
                tableHTML += '</tbody></table>';
                diagnosisHTML += tableHTML;
                
                // 根据原发继发原则生成最终诊断
                let finalDiagnosis = '';
                
                // 检查是否存在矛盾的诊断
                const hasAccInsufficiency = diagnoses.some(item => item.name === '调节不足' && item.metNecessary);
                const hasAccExcess = diagnoses.some(item => item.name === '调节过度' && item.metNecessary);
                const hasConvInsufficiency = diagnoses.some(item => item.name === '集合不足' && item.metNecessary);
                const hasConvExcess = diagnoses.some(item => item.name === '集合过度' && item.metNecessary);
                
                // 获取诊断对象
                const accInsufficiency = diagnoses.find(item => item.name === '调节不足' && item.metNecessary);
                const accExcess = diagnoses.find(item => item.name === '调节过度' && item.metNecessary);
                const convInsufficiency = diagnoses.find(item => item.name === '集合不足' && item.metNecessary);
                const convExcess = diagnoses.find(item => item.name === '集合过度' && item.metNecessary);
                
                // 处理调节矛盾
                let accDiagnosis = null;
                if (hasAccInsufficiency && hasAccExcess) {
                    // 调节不足和调节过度同时满足必要条件，按充分不必要条件计数决定
                    if (accInsufficiency.optionalCount >= accExcess.optionalCount) {
                        accDiagnosis = '调节不足';
                    } else {
                        accDiagnosis = '调节过度';
                    }
                } else if (hasAccInsufficiency) {
                    accDiagnosis = '调节不足';
                } else if (hasAccExcess) {
                    accDiagnosis = '调节过度';
                }
                
                // 处理集合矛盾
                let convDiagnosis = null;
                if (hasConvInsufficiency && hasConvExcess) {
                    // 集合不足和集合过度同时满足必要条件，按充分不必要条件计数决定
                    if (convInsufficiency.optionalCount >= convExcess.optionalCount) {
                        convDiagnosis = '集合不足';
                    } else {
                        convDiagnosis = '集合过度';
                    }
                } else if (hasConvInsufficiency) {
                    convDiagnosis = '集合不足';
                } else if (hasConvExcess) {
                    convDiagnosis = '集合过度';
                }
                
                // 处理散开矛盾
                let divDiagnosis = null;
                const hasDivInsufficiency = diagnoses.some(item => item.name === '散开不足' && item.metNecessary);
                const hasDivExcess = diagnoses.some(item => item.name === '散开过度' && item.metNecessary);
                const divInsufficiency = diagnoses.find(item => item.name === '散开不足' && item.metNecessary);
                const divExcess = diagnoses.find(item => item.name === '散开过度' && item.metNecessary);
                
                if (hasDivInsufficiency && hasDivExcess) {
                    // 散开不足和散开过度同时满足必要条件，按充分不必要条件计数决定
                    if (divInsufficiency.optionalCount >= divExcess.optionalCount) {
                        divDiagnosis = '散开不足';
                    } else {
                        divDiagnosis = '散开过度';
                    }
                } else if (hasDivInsufficiency) {
                    divDiagnosis = '散开不足';
                } else if (hasDivExcess) {
                    divDiagnosis = '散开过度';
                }
                
                // 应用原发继发原则
                if (accDiagnosis && convDiagnosis) {
                    if (accDiagnosis === '调节过度' && convDiagnosis === '集合过度') {
                        finalDiagnosis = '原发调节过度并继发集合过度';
                    } else if (accDiagnosis === '调节不足' && convDiagnosis === '集合不足') {
                        finalDiagnosis = '原发调节不足并继发集合不足';
                    } else if (accDiagnosis === '调节过度' && convDiagnosis === '集合不足') {
                        finalDiagnosis = '原发集合不足并继发调节过度';
                    } else if (accDiagnosis === '调节不足' && convDiagnosis === '集合过度') {
                        finalDiagnosis = '原发集合过度并继发调节不足';
                    }
                } else if (accDiagnosis) {
                    finalDiagnosis = accDiagnosis;
                } else if (convDiagnosis) {
                    finalDiagnosis = convDiagnosis;
                } else if (divDiagnosis) {
                    finalDiagnosis = divDiagnosis;
                } else if (diagnoses.length > 0) {
                    // 如果有多个诊断，将它们都列出来
                    const diagnosisNames = diagnoses.map(d => d.name);
                    // 如果诊断中包含相互矛盾的类型（如同时有内隐斜和外隐斜）
                    // 可以添加特殊说明
                    if (diagnosisNames.some(name => name.includes('内隐斜')) && 
                        diagnosisNames.some(name => name.includes('外隐斜'))) {
                        finalDiagnosis = '混合型隐斜：' + diagnosisNames.join('、');
                    } else {
                        finalDiagnosis = diagnosisNames.join('、');
                    }
                }
                
                if (finalDiagnosis) {
                    diagnosisHTML += `<h4 style="margin-top: 20px;">最终诊断</h4><p>${finalDiagnosis}</p>`;
                    
                    // 保存最终诊断到全局变量
                    currentFinalDiagnosis = finalDiagnosis;
                    
                    // 获取所有诊断名称
                    const allDiagnoses = diagnoses.map(d => d.name);
                    
                    // 根据所有诊断生成综合训练方案
                    let trainingHTML = '<div class="training-plan">';
                    trainingHTML += '<h4>视觉训练方案</h4>';
                    
                    // 训练方案映射（根据诊断名称）
                    const trainingMap = {
                        '集合不足': '推近训练，聚散球训练，BO棱镜训练，裂隙尺训练等',
                        '集合过度': '正镜附加，聚散球训练，BI棱镜训练，放松训练等',
                        '散开不足': '配BO棱镜，散开训练，红绿可变矢量图等',
                        '散开过度': '负球镜过矫，BI棱镜，集合训练等',
                        '基本型外隐斜': '棱镜矫正，BO棱镜训练，集合训练等',
                        '基本型内隐斜': '棱镜矫正，BI棱镜训练，散开训练等',
                        '远距离外隐斜': '远BO融像训练，集合训练等',
                        '远距离内隐斜': '远BI融像训练，散开训练等',
                        '近距离外隐斜': '近BO融像训练，集合训练等',
                        '近距离内隐斜': '近BI融像训练，散开训练等',
                        '基本型外隐斜（满足对应法则，正常！）': '眼位正常，无需特殊训练，定期复查即可',
                        '基本型内隐斜（满足对应法则，正常！）': '眼位正常，无需特殊训练，定期复查即可',
                        '基本型外隐斜（远近眼位都不满足谢尔德法则）': '远距离和近距离BO融像训练，集合训练，棱镜矫正等',
                        '基本型内隐斜（远近眼位都不满足1:1法则）': '远距离和近距离BI融像训练，散开训练，棱镜矫正等',
                        '基本型外隐斜（远外隐斜满足谢尔德法则，近外隐斜不满足谢尔德法则）': '近距离BO融像训练，集合训练，聚散球训练等',
                        '基本型外隐斜（远外隐斜不满足谢尔德法则，近外隐斜满足谢尔德法则）': '远距离BO融像训练，集合训练，推近训练等',
                        '基本型内隐斜（远内隐斜满足1:1法则，近内隐斜不满足1:1法则）': '近距离BI融像训练，散开训练，放松训练等',
                        '基本型内隐斜（远内隐斜不满足1:1法则，近内隐斜满足1:1法则）': '远距离BI融像训练，散开训练，正镜附加训练等',
                        '调节不足': '推近训练，球镜翻转拍，远近字母表，调节训练软件等',
                        '调节过度': '正镜片阅读，球镜翻转拍，放松训练，远近字母表等',
                        '调节灵活度不良': '远近字母表，球镜翻转拍，调节灵敏度训练等',
                        '原发调节过度并继发集合过度': '正镜片阅读，球镜翻转拍，聚散球训练，BI棱镜训练，放松训练等',
                        '原发调节不足并继发集合不足': '推近训练，球镜翻转拍，聚散球训练，BO棱镜训练，裂隙尺训练等',
                        '原发集合不足并继发调节过度': '聚散球训练，BO棱镜训练，正镜片阅读，球镜翻转拍，放松训练等',
                        '原发集合过度并继发调节不足': '聚散球训练，BI棱镜训练，推近训练，球镜翻转拍，调节刺激训练等'
                    };
                    
                    if (allDiagnoses.length === 1) {
                        // 单个诊断的情况
                        let trainingMethod = trainingMap[finalDiagnosis];
                        
                        if (!trainingMethod) {
                            // 如果找不到精确匹配，尝试部分匹配
                            if (finalDiagnosis.includes('调节')) {
                                trainingMethod = '球镜翻转拍，远近字母表，调节训练软件等';
                            } else if (finalDiagnosis.includes('集合')) {
                                trainingMethod = '聚散球训练，棱镜翻转拍，裂隙尺训练等';
                            } else if (finalDiagnosis.includes('散开')) {
                                trainingMethod = '聚散球训练，棱镜翻转拍，红绿可变矢量图等';
                            } else if (finalDiagnosis.includes('外隐斜')) {
                                trainingMethod = '棱镜矫正，BO棱镜训练，集合训练等';
                            } else if (finalDiagnosis.includes('内隐斜')) {
                                trainingMethod = '棱镜矫正，BI棱镜训练，散开训练等';
                            } else if (finalDiagnosis.includes('满足对应法则，正常！')) {
                                trainingMethod = '眼位正常，无需特殊训练，定期复查即可';
                            } else {
                                trainingMethod = '根据具体症状制定个性化训练方案';
                            }
                        }
                        
                        trainingHTML += `<p>根据最终诊断「${finalDiagnosis}」，推荐以下视觉训练方案：</p>`;
                        trainingHTML += `<p><strong>训练方法：</strong> ${trainingMethod}</p>`;
                        
                        // 保存训练方案到全局变量
                        currentTrainingPlan = trainingMethod;
                    } else {
                        // 多个诊断的情况
                        trainingHTML += '<p>由于存在多个视功能异常，需要综合训练方案：</p><ul>';
                        
                        // 保存训练方案到全局变量（简化的版本）
                        const trainingMethods = [];
                        
                        // 根据原发继发原则，优先训练原发问题
                        if (finalDiagnosis === '原发调节不足并继发集合不足') {
                            trainingHTML += `<li><span class="training-type">首先训练调节不足（原发问题）：</span><span class="training-methods">推近训练，球镜翻转拍，远近字母表，调节训练软件等</span></li>`;
                            trainingHTML += `<li><span class="training-type">然后训练集合不足（继发问题）：</span><span class="training-methods">推近训练，聚散球训练，BO棱镜训练，裂隙尺训练等</span></li>`;
                            
                            trainingMethods.push('首先训练调节不足（原发问题）：推近训练，球镜翻转拍，远近字母表，调节训练软件等');
                            trainingMethods.push('然后训练集合不足（继发问题）：推近训练，聚散球训练，BO棱镜训练，裂隙尺训练等');
                        } else if (finalDiagnosis === '原发调节过度并继发集合过度') {
                            trainingHTML += `<li><span class="training-type">首先训练调节过度（原发问题）：</span><span class="training-methods">正镜片阅读，球镜翻转拍，放松训练，远近字母表等</span></li>`;
                            trainingHTML += `<li><span class="training-type">然后训练集合过度（继发问题）：</span><span class="training-methods">正镜附加，聚散球训练，BI棱镜训练，放松训练等</span></li>`;
                            
                            trainingMethods.push('首先训练调节过度（原发问题）：正镜片阅读，球镜翻转拍，放松训练，远近字母表等');
                            trainingMethods.push('然后训练集合过度（继发问题）：正镜附加，聚散球训练，BI棱镜训练，放松训练等');
                        } else if (finalDiagnosis === '原发集合不足并继发调节过度') {
                            trainingHTML += `<li><span class="training-type">首先训练集合不足（原发问题）：</span><span class="training-methods">推近训练，聚散球训练，BO棱镜训练，裂隙尺训练等</span></li>`;
                            trainingHTML += `<li><span class="training-type">然后训练调节过度（继发问题）：</span><span class="training-methods">正镜片阅读，球镜翻转拍，放松训练，远近字母表等</span></li>`;
                            
                            trainingMethods.push('首先训练集合不足（原发问题）：推近训练，聚散球训练，BO棱镜训练，裂隙尺训练等');
                            trainingMethods.push('然后训练调节过度（继发问题）：正镜片阅读，球镜翻转拍，放松训练，远近字母表等');
                        } else if (finalDiagnosis === '原发集合过度并继发调节不足') {
                            trainingHTML += `<li><span class="training-type">首先训练集合过度（原发问题）：</span><span class="training-methods">正镜附加，聚散球训练，BI棱镜训练，放松训练等</span></li>`;
                            trainingHTML += `<li><span class="training-type">然后训练调节不足（继发问题）：</span><span class="training-methods">推近训练，球镜翻转拍，远近字母表，调节训练软件等</span></li>`;
                            
                            trainingMethods.push('首先训练集合过度（原发问题）：正镜附加，聚散球训练，BI棱镜训练，放松训练等');
                            trainingMethods.push('然后训练调节不足（继发问题）：推近训练，球镜翻转拍，远近字母表，调节训练软件等');
                        } else {
                            // 其他情况，为每个诊断提供相应的训练建议
                            allDiagnoses.forEach(diagnosisName => {
                                let trainingMethod = trainingMap[diagnosisName];
                                
                                if (!trainingMethod) {
                                    // 如果找不到精确匹配，尝试部分匹配
                                    if (diagnosisName.includes('调节')) {
                                        trainingMethod = '球镜翻转拍，远近字母表，调节训练软件等';
                                    } else if (diagnosisName.includes('集合')) {
                                        trainingMethod = '聚散球训练，棱镜翻转拍，裂隙尺训练等';
                                    } else if (diagnosisName.includes('散开')) {
                                        trainingMethod = '聚散球训练，棱镜翻转拍，红绿可变矢量图等';
                                    } else if (diagnosisName.includes('外隐斜')) {
                                        trainingMethod = '棱镜矫正，BO棱镜训练，集合训练等';
                                    } else if (diagnosisName.includes('内隐斜')) {
                                        trainingMethod = '棱镜矫正，BI棱镜训练，散开训练等';
                                    } else if (diagnosisName.includes('满足对应法则，正常！')) {
                                        trainingMethod = '眼位正常，无需特殊训练，定期复查即可';
                                    } else {
                                        trainingMethod = '根据具体症状制定个性化训练方案';
                                    }
                                }
                                
                                if (trainingMethod) {
                                    trainingHTML += `<li><span class="training-type">${diagnosisName}：</span><span class="training-methods">${trainingMethod}</span></li>`;
                                    trainingMethods.push(`${diagnosisName}：${trainingMethod}`);
                                }
                            });
                            
                            trainingHTML += '</ul>';
                            trainingHTML += '<p><strong>训练顺序建议：</strong>先解决主要症状，通常建议先训练集合功能，再训练调节功能。</p>';
                        }
                        
                        trainingHTML += '</ul>';
                        
                        // 如果没有特殊处理，添加一般建议
                        if (!finalDiagnosis.includes('原发') || !finalDiagnosis.includes('继发')) {
                            trainingHTML += '<p><strong>训练顺序建议：</strong>先解决主要症状，通常建议先训练集合功能，再训练调节功能。</p>';
                        }
                        
                        // 保存训练方案到全局变量
                        currentTrainingPlan = trainingMethods.join('\n') + '\n\n训练顺序建议：先解决主要症状，通常建议先训练集合功能，再训练调节功能。';
                    }
                    
                    trainingHTML += '</div>';
                    
                    // 将诊断结果和训练方案都放入容器
                    containerDiv.innerHTML = diagnosisHTML + trainingHTML;
                } else {
                    // 如果没有最终诊断，使用旧的逻辑
                    generateTrainingPlanByDiagnoses(diagnoses, diagnosisHTML, containerDiv);
                }
            } else {
                diagnosisHTML += '<p>所有检查结果均在正常范围内，未发现明显视功能异常。</p>';
                diagnosisHTML += '<div class="training-plan">';
                diagnosisHTML += '<h4>视觉训练方案</h4>';
                diagnosisHTML += '<p>视功能检查结果正常，无需特殊训练方案。建议定期复查视功能，保持良好的用眼习惯。</p>';
                diagnosisHTML += '</div>';
                containerDiv.innerHTML = diagnosisHTML;
                
                // 设置全局变量
                currentFinalDiagnosis = '所有检查结果均在正常范围内';
                currentTrainingPlan = '无需特殊训练方案，建议定期复查视功能';
            }
        }
        
        // 旧的训练方案生成逻辑（根据所有诊断）
        function generateTrainingPlanByDiagnoses(diagnoses, diagnosisHTML, containerDiv) {
            let trainingHTML = '<div class="training-plan">';
            
            if (diagnoses.length > 0) {
                trainingHTML += '<h4>视觉训练方案</h4>';
                
                // 训练方案映射
                const trainingMap = {
                    '集合不足': '推近训练，聚散球训练，BO棱镜训练，裂隙尺训练等',
                    '集合过度': '正镜附加，聚散球训练，BI棱镜训练，放松训练等',
                    '散开不足': '配BO棱镜，散开训练，红绿可变矢量图等',
                    '散开过度': '负球镜过矫，BI棱镜，集合训练等',
                    '基本型外隐斜': '棱镜矫正，BO棱镜训练，集合训练等',
                    '基本型内隐斜': '棱镜矫正，BI棱镜训练，散开训练等',
                    '远距离外隐斜': '远BO融像训练，集合训练等',
                    '远距离内隐斜': '远BI融像训练，散开训练等',
                    '近距离外隐斜': '近BO融像训练，集合训练等',
                    '近距离内隐斜': '近BI融像训练，散开训练等',
                    '基本型外隐斜（满足对应法则，正常！）': '眼位正常，无需特殊训练，定期复查即可',
                    '基本型内隐斜（满足对应法则，正常！）': '眼位正常，无需特殊训练，定期复查即可',
                    '基本型外隐斜（远近眼位都不满足谢尔德法则）': '远距离和近距离BO融像训练，集合训练，棱镜矫正等',
                    '基本型内隐斜（远近眼位都不满足1:1法则）': '远距离和近距离BI融像训练，散开训练，棱镜矫正等',
                    '基本型外隐斜（远外隐斜满足谢尔德法则，近外隐斜不满足谢尔德法则）': '近距离BO融像训练，集合训练，聚散球训练等',
                    '基本型外隐斜（远外隐斜不满足谢尔德法则，近外隐斜满足谢尔德法则）': '远距离BO融像训练，集合训练，推近训练等',
                    '基本型内隐斜（远内隐斜满足1:1法则，近内隐斜不满足1:1法则）': '近距离BI融像训练，散开训练，放松训练等',
                    '基本型内隐斜（远内隐斜不满足1:1法则，近内隐斜满足1:1法则）': '远距离BI融像训练，散开训练，正镜附加训练等',
                    '调节不足': '推近训练，球镜翻转拍，远近字母表，调节训练软件等',
                    '调节过度': '正镜片阅读，球镜翻转拍，放松训练，远近字母表等',
                    '调节灵活度不良': '远近字母表，球镜翻转拍，调节灵敏度训练等',
                    '调节超前': '正镜片阅读，远近字母表，球镜翻转拍，放松训练等',
                    '调节滞后': '推近训练，远近字母表，球镜翻转拍，调节刺激训练等',
                    '调节性集合不足': '推近训练，聚散球训练，AC/A训练等',
                    '调节性集合过度': '正镜附加，聚散球训练，AC/A训练等'
                };
                
                trainingHTML += '<p>根据检测到的异常，提供以下视觉训练方案建议：</p><ul>';
                
                // 按可选条件数从高到低排序，先显示计数高的诊断
                const sortedDiagnoses = [...diagnoses].sort((a, b) => b.optionalCount - a.optionalCount);
                
                sortedDiagnoses.forEach(diagnosis => {
                    let trainingMethod = '';
                    const diagnosisName = diagnosis.name;
                    
                    // 查找对应的训练方案
                    for (const key in trainingMap) {
                        if (diagnosisName.includes(key)) {
                            trainingMethod = trainingMap[key];
                            break;
                        }
                    }
                    
                    if (!trainingMethod) {
                        // 如果找不到精确匹配，尝试部分匹配
                        if (diagnosisName.includes('调节')) {
                            trainingMethod = '球镜翻转拍，远近字母表，调节训练软件等';
                        } else if (diagnosisName.includes('集合')) {
                            trainingMethod = '聚散球训练，棱镜翻转拍，裂隙尺训练等';
                        } else if (diagnosisName.includes('散开')) {
                            trainingMethod = '聚散球训练，棱镜翻转拍，红绿可变矢量图等';
                        } else if (diagnosisName.includes('外隐斜') || diagnosisName.includes('内隐斜')) {
                            trainingMethod = '棱镜矫正，相应的棱镜训练，融像训练等';
                        } else if (diagnosisName.includes('满足对应法则，正常！')) {
                            trainingMethod = '眼位正常，无需特殊训练，定期复查即可';
                        }
                    }
                    
                    if (trainingMethod) {
                        trainingHTML += `
                            <li>
                                <span class="training-type">${diagnosisName} (${diagnosis.optionalCount}个条件)：</span>
                                <span class="training-methods">${trainingMethod}</span>
                            </li>
                        `;
                    }
                });
                
                trainingHTML += '</ul>';
            } else {
                trainingHTML += '<h4>视觉训练方案</h4><p>视功能检查结果正常，无需特殊训练方案。</p>';
            }
            
            trainingHTML += '</div>';
            
            // 将诊断结果和训练方案都放入容器
            containerDiv.innerHTML = diagnosisHTML + trainingHTML;
        }
        
        // 添加结果项目
        function addResultItem(container, label, value, status, diagnosis) {
            const statusClass = status === 'normal' ? 'normal' : 'abnormal';
            const statusText = status === 'normal' ? '正常' : '异常';
            const statusBgClass = status === 'normal' ? 'status-normal' : 'status-abnormal';
            
            const item = document.createElement('div');
            item.className = `result-item ${statusClass}`;
            item.innerHTML = `
                <div class="result-label">${label}</div>
                <div class="result-value">${value}</div>
                <div class="result-status ${statusBgClass}">${statusText}</div>
            `;
            
            container.appendChild(item);
            
            // 添加诊断说明
            if (diagnosis) {
                const diagnosisItem = document.createElement('div');
                diagnosisItem.className = 'range-hint';
                diagnosisItem.style.marginTop = '5px';
                diagnosisItem.style.marginBottom = '15px';
                diagnosisItem.style.paddingLeft = '10px';
                diagnosisItem.style.borderLeft = '3px solid ' + (status === 'normal' ? '#4caf50' : '#f44336');
                diagnosisItem.textContent = diagnosis;
                container.appendChild(diagnosisItem);
            }
        }
        
        // 格式化度数显示
        function formatDiopter(value) {
            if (isNaN(value)) return '-';
            return (value >= 0 ? '+' : '') + value.toFixed(2);
        }
        
        // 格式化棱镜度显示
        function formatPrism(value) {
            if (isNaN(value)) return '-';
            return (value >= 0 ? '+' : '') + value + '△';
        }
        
        // ===================== 打印报告功能 - 已修改为紧凑且居中的格式 =====================
        function printReport() {
            // 获取患者信息
            const patientName = document.getElementById('patient-name').value || '未填写';
            const patientAge = document.getElementById('result-age').textContent || '-';
            const checkDate = document.getElementById('result-date').textContent || '-';
            
            // 获取当前时间
            const now = new Date();
            const generateTime = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            // 获取所有分析结果
            const accommodationResults = document.getElementById('accommodation-results').innerHTML;
            const vergenceResults = document.getElementById('vergence-results').innerHTML;
            const flipperResults = document.getElementById('flipper-results').innerHTML;
            const diagnosisTrainingContent = document.getElementById('diagnosis-training-container').innerHTML;
            
            // 创建紧凑的打印内容
            const printContent = `
                <div id="printable-report" class="no-page-break">
                    <!-- 报告标题 -->
                    <div class="print-report-header">
                        <h1>视功能检查分析报告</h1>
                    </div>
                    
                    <!-- 患者信息 -->
                    <div class="patient-info-print no-page-break">
                        <table>
                            <tr>
                                <td><strong>姓名：</strong>${patientName}</td>
                                <td><strong>年龄：</strong>${patientAge}</td>
                                <td><strong>检查日期：</strong>${checkDate}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- 调节功能结果 -->
                    <div class="print-section no-page-break">
                        <h3>调节功能分析结果</h3>
                        ${formatResultsForPrint(accommodationResults)}
                    </div>
                    
                    <!-- 集合功能结果 -->
                    <div class="print-section no-page-break">
                        <h3>集合功能分析结果</h3>
                        ${formatResultsForPrint(vergenceResults)}
                    </div>
                    
                    <!-- 翻转拍检查结果 -->
                    <div class="print-section no-page-break">
                        <h3>翻转拍检查分析结果</h3>
                        ${formatResultsForPrint(flipperResults)}
                    </div>
                    
                    <!-- 最终诊断 -->
                    <div class="print-final-diagnosis no-page-break">
                        <h4>最终诊断</h4>
                        <p>${currentFinalDiagnosis}</p>
                    </div>
                    
                    <!-- 训练方案 -->
                    <div class="print-training-plan no-page-break">
                        <h4>视觉训练方案</h4>
                        ${formatTrainingPlanForPrint()}
                    </div>
                    
                    <!-- 页脚 -->
                    <div class="print-footer">
                        <p>© 2026 视功能检查分析工具</p>
                        <p>本报告由视功能检查分析工具生成，仅供参考，不能替代专业医疗建议。</p>
                        <p>生成时间：${generateTime}</p>
                    </div>
                </div>
            `;
            
            // 将内容放入打印容器
            const printableReport = document.getElementById('printable-report');
            printableReport.innerHTML = printContent;
            printableReport.style.display = 'block';
            
            // 触发打印
            setTimeout(() => {
                window.print();
                // 打印后隐藏打印内容
                setTimeout(() => {
                    printableReport.style.display = 'none';
                }, 100);
            }, 100);
        }
        
        // 格式化结果用于打印
        function formatResultsForPrint(htmlContent) {
            if (!htmlContent) return '<p>无数据</p>';
            
            // 创建一个临时div来解析HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            
            // 获取所有.result-item元素
            const resultItems = tempDiv.querySelectorAll('.result-item');
            if (resultItems.length === 0) return '<p>无数据</p>';
            
            let resultHTML = '';
            
            resultItems.forEach(item => {
                const label = item.querySelector('.result-label').textContent;
                const value = item.querySelector('.result-value').textContent;
                const status = item.querySelector('.result-status').textContent;
                const isAbnormal = item.classList.contains('abnormal');
                
                // 查找诊断说明
                let diagnosis = '';
                const nextSibling = item.nextElementSibling;
                if (nextSibling && nextSibling.classList.contains('range-hint')) {
                    diagnosis = nextSibling.textContent;
                }
                
                const statusClass = isAbnormal ? 'abnormal' : 'normal';
                
                resultHTML += `
                    <div class="print-result-item ${statusClass}">
                        <div>${label}: ${value}</div>
                        <div>${status}</div>
                    </div>
                `;
                
                if (diagnosis) {
                    resultHTML += `<div style="font-size: 7pt; margin-left: 10px; margin-bottom: 3px; color: ${isAbnormal ? '#d32f2f' : '#388e3c'};">${diagnosis}</div>`;
                }
            });
            
            return resultHTML;
        }
        
        // 格式化训练方案用于打印
        function formatTrainingPlanForPrint() {
            if (!currentTrainingPlan) return '<p>无训练方案建议</p>';
            
            // 检查训练方案是否是简单的字符串
            if (typeof currentTrainingPlan === 'string' && !currentTrainingPlan.includes('\n')) {
                return `<p>${currentTrainingPlan}</p>`;
            }
            
            // 如果是多行文本，转换为HTML
            let html = '';
            const lines = currentTrainingPlan.split('\n');
            
            for (let line of lines) {
                if (line.trim()) {
                    if (line.includes('：')) {
                        // 包含冒号的行，可能是诊断名称
                        const parts = line.split('：');
                        if (parts.length >= 2) {
                            html += `<p style="margin: 3px 0;"><strong>${parts[0]}：</strong>${parts.slice(1).join('：')}</p>`;
                        } else {
                            html += `<p style="margin: 3px 0;">${line}</p>`;
                        }
                    } else if (line.includes('训练顺序建议：')) {
                        html += `<p style="margin-top: 8px; font-weight: bold;">${line}</p>`;
                    } else {
                        html += `<p style="margin: 3px 0;">${line}</p>`;
                    }
                }
            }
            
            return html;
        }
        
        // ===================== 保存报告为文本功能 =====================
        function saveReportAsText() {
            // 获取患者信息
            const patientName = document.getElementById('patient-name').value || '未填写';
            const patientAge = document.getElementById('result-age').textContent || '-';
            const checkDate = document.getElementById('result-date').textContent || '-';
            
            // 获取当前时间
            const now = new Date();
            const generateTime = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            // 构建报告文本
            let reportText = '';
            reportText += "=".repeat(50) + "\n";
            reportText += "视功能检查分析报告\n";
            reportText += "=".repeat(50) + "\n\n";
            
            reportText += "患者信息：\n";
            reportText += `  姓名：${patientName}\n`;
            reportText += `  年龄：${patientAge}\n`;
            reportText += `  检查日期：${checkDate}\n\n`;
            
            // 获取所有结果数据
            const accommodationResults = document.getElementById('accommodation-results').innerHTML;
            const vergenceResults = document.getElementById('vergence-results').innerHTML;
            const flipperResults = document.getElementById('flipper-results').innerHTML;
            
            // 解析调节功能结果
            reportText += "调节功能分析结果：\n";
            reportText += parseResultsForText(accommodationResults) + "\n";
            
            // 解析集合功能结果
            reportText += "集合功能分析结果：\n";
            reportText += parseResultsForText(vergenceResults) + "\n";
            
            // 解析翻转拍检查结果
            reportText += "翻转拍检查分析结果：\n";
            reportText += parseResultsForText(flipperResults) + "\n";
            
            reportText += "最终诊断：\n";
            reportText += `  ${currentFinalDiagnosis}\n\n`;
            
            reportText += "视觉训练方案：\n";
            
            // 处理训练方案文本
            if (currentTrainingPlan) {
                if (typeof currentTrainingPlan === 'string') {
                    if (currentTrainingPlan.includes('\n')) {
                        // 多行文本
                        const lines = currentTrainingPlan.split('\n');
                        for (let line of lines) {
                            if (line.trim()) {
                                reportText += `  ${line}\n`;
                            }
                        }
                    } else {
                        // 单行文本
                        reportText += `  ${currentTrainingPlan}\n`;
                    }
                }
            } else {
                reportText += "  无训练方案建议\n";
            }
            
            reportText += "\n" + "=".repeat(50) + "\n";
            reportText += "© 2026 视功能检查分析工具\n";
            reportText += "本报告由视功能检查分析工具生成，仅供参考，不能替代专业医疗建议。\n";
            reportText += `生成时间：${generateTime}\n`;
            reportText += "=".repeat(50) + "\n";
            
            // 创建Blob并下载
            const blob = new Blob([reportText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            
            // 生成文件名
            const fileName = `视功能检查报告_${patientName}_${checkDate.replace(/\//g, '-')}.txt`;
            
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        
        // 解析结果用于文本保存
        function parseResultsForText(htmlContent) {
            if (!htmlContent) return "  无数据\n";
            
            // 创建一个临时div来解析HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            
            // 获取所有.result-item元素
            const resultItems = tempDiv.querySelectorAll('.result-item');
            if (resultItems.length === 0) return "  无数据\n";
            
            let resultText = '';
            
            resultItems.forEach(item => {
                const label = item.querySelector('.result-label').textContent;
                const value = item.querySelector('.result-value').textContent;
                const status = item.querySelector('.result-status').textContent;
                const isAbnormal = item.classList.contains('abnormal');
                
                // 查找诊断说明
                let diagnosis = '';
                const nextSibling = item.nextElementSibling;
                if (nextSibling && nextSibling.classList.contains('range-hint')) {
                    diagnosis = nextSibling.textContent;
                }
                
                resultText += `  ${label}: ${value} (${status})`;
                if (diagnosis) {
                    resultText += ` - ${diagnosis}`;
                }
                resultText += "\n";
            });
            
            return resultText;
        }
    </script>
</body>
</html>